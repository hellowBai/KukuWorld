# Kuku收集塔防游戏《Kuku Collector》进化系统设计文档

## 1. 系统概述

进化系统是《Kuku Collector》游戏的核心玩法之一，允许玩家通过吸收灵魂来提升kuku的稀有度和能力。该系统特别针对神话kuku设计，使其能够通过吸收野怪灵魂进化，提升稀有度和属性，最终达到可融合的最终形态。

## 2. 系统架构

### 2.1 EvolutionSystem (进化系统)
- **职责**: 管理库库进化逻辑，处理进化成功率，计算进化后属性
- **类型**: 静态系统类
- **依赖**: MythicalKukuData, PlayerData

## 3. EvolutionSystem (进化系统)

### 3.1 类定义
```csharp
public static class EvolutionSystem
```

### 3.2 系统职责
- 处理kuku进化逻辑
- 管理进化成功率
- 计算进化后属性
- 支持灵魂吸收进化机制
- 验证进化条件

### 3.3 数据结构

#### 3.3.1 EvolutionResult (进化结果结构)
```csharp
public struct EvolutionResult
{
    public bool success;
    public MythicalKukuData evolvedKuku;
    public string message;
    public bool isFinalEvolution;     // 是否达到最终进化等级（可融合）

    public EvolutionResult(bool isSuccess, MythicalKukuData kuku, string msg, bool isFinal = false)
    {
        success = isSuccess;
        evolvedKuku = kuku;
        message = msg;
        isFinalEvolution = isFinal;
    }
}
```

#### 3.3.2 灵魂类型枚举
```csharp
public enum SoulType 
{ 
    Common,     // 普通灵魂
    Rare,       // 稀有灵魂
    Epic,       // 史诗灵魂
    Legendary,  // 传说灵魂
    Mythic,     // 神话灵魂
    Divine      // 神圣灵魂
}
```

### 3.4 核心方法

#### 3.4.1 进化方法
```csharp
/// <summary>
/// 尝试进化kuku
/// </summary>
public static EvolutionResult EvolveKuku(MythicalKukuData kuku)
{
    // 检查kuku是否可以进化
    if (kuku == null || kuku.EvolutionLevel >= 5) // 假设最高进化等级为5
    {
        return new EvolutionResult(false, kuku, "kuku已达到最高进化等级！");
    }

    // 检查是否有足够的进化材料
    if (GameManager.Instance?.PlayerData.Souls < kuku.EvolutionStonesRequired)
    {
        return new EvolutionResult(false, kuku, $"灵魂不足，需要 {kuku.EvolutionStonesRequired} 点灵魂");
    }

    // 计算进化成功率
    float successRate = GetEvolutionSuccessRate(kuku);

    if (Random.value <= successRate)
    {
        // 进化成功
        MythicalKukuData evolvedKuku = new MythicalKukuData();
        
        // 复制原始数据
        evolvedKuku.Id = kuku.Id;
        evolvedKuku.Name = kuku.Name;
        evolvedKuku.Description = kuku.Description;
        evolvedKuku.Element = kuku.Element;
        evolvedKuku.SkillType = kuku.SkillType;
        evolvedKuku.SkillDescription = kuku.SkillDescription;
        evolvedKuku.SkillRange = kuku.SkillRange;
        evolvedKuku.SkillPower = kuku.SkillPower;

        // 提升稀有度
        if ((int)kuku.Rarity < System.Enum.GetValues(typeof(MythicalKukuData.MythicalRarity)).Length - 1)
        {
            evolvedKuku.Rarity = (MythicalKukuData.MythicalRarity)((int)kuku.Rarity + 1);
        }
        else
        {
            evolvedKuku.Rarity = kuku.Rarity;
        }

        // 提升进化等级
        evolvedKuku.EvolutionLevel = kuku.EvolutionLevel + 1;
        evolvedKuku.EvolutionProgress = 0f;
        evolvedKuku.EvolutionStonesRequired = kuku.EvolutionStonesRequired + 10; // 每级增加10点需求

        // 增强属性
        evolvedKuku.AttackPower = kuku.AttackPower * 1.2f;
        evolvedKuku.DefensePower = kuku.DefensePower * 1.2f;
        evolvedKuku.Speed = kuku.Speed * 1.1f;
        evolvedKuku.Health = kuku.Health * 1.25f;
        evolvedKuku.DivinePower = kuku.DivinePower * 1.15f;
        evolvedKuku.ProtectionPower = kuku.ProtectionPower * 1.15f;
        evolvedKuku.PurificationPower = kuku.PurificationPower * 1.15f;

        // 检查是否达到最终进化形态（可融合）
        bool isFinal = evolvedKuku.EvolutionLevel >= 5;

        // 消耗灵魂
        if (GameManager.Instance?.PlayerData != null)
        {
            GameManager.Instance.PlayerData.AddSouls(-kuku.EvolutionStonesRequired);
        }

        string message = $"进化成功！{kuku.Name} 进化为 {evolvedKuku.Rarity} 级别！";
        if (isFinal)
        {
            message += " 已达到最终进化形态，可与其他单位融合！";
            evolvedKuku.CanFuseWithRobots = true;
        }

        return new EvolutionResult(true, evolvedKuku, message, isFinal);
    }
    else
    {
        // 进化失败，消耗一半的灵魂
        if (GameManager.Instance?.PlayerData != null)
        {
            GameManager.Instance.PlayerData.AddSouls(-kuku.EvolutionStonesRequired / 2);
        }

        return new EvolutionResult(false, kuku, "进化失败！消耗了一半的灵魂。");
    }
}
```

#### 3.4.2 通过灵魂吸收进化方法
```csharp
/// <summary>
/// 通过吸收灵魂进化kuku
/// </summary>
public static EvolutionResult EvolveKukuWithSoul(MythicalKukuData kuku, float soulPower, SoulType soulType)
{
    if (kuku == null)
    {
        return new EvolutionResult(false, kuku, "无效的kuku数据！");
    }

    // 检查kuku是否可以吸收灵魂
    if (!kuku.CanAbsorbSoul)
    {
        return new EvolutionResult(false, kuku, "该kuku无法吸收灵魂！");
    }

    // 计算灵魂吸收效果
    float effectiveness = CalculateSoulEffectiveness(kuku, soulPower, soulType);

    // 根据灵魂类型调整成功率
    float multiplier = 1.0f;
    switch (soulType)
    {
        case SoulType.Common: multiplier = 0.5f; break;
        case SoulType.Rare: multiplier = 0.7f; break;
        case SoulType.Epic: multiplier = 1.0f; break;
        case SoulType.Legendary: multiplier = 1.3f; break;
        case SoulType.Mythic: multiplier = 1.6f; break;
        case SoulType.Divine: multiplier = 2.0f; break;
    }

    effectiveness *= multiplier;

    // 检查是否能进化到下一个稀有度
    bool canEvolveRarity = (int)kuku.Rarity < System.Enum.GetValues(typeof(MythicalKukuData.MythicalRarity)).Length - 1;
    bool canEvolveLevel = kuku.EvolutionLevel < 5;

    if (effectiveness >= 1.0f && (canEvolveRarity || canEvolveLevel))
    {
        // 成功进化
        MythicalKukuData evolvedKuku = new MythicalKukuData();
        
        // 复制原始数据
        evolvedKuku.Id = kuku.Id;
        evolvedKuku.Name = kuku.Name;
        evolvedKuku.Description = kuku.Description;
        evolvedKuku.Element = kuku.Element;
        evolvedKuku.SkillType = kuku.SkillType;
        evolvedKuku.SkillDescription = kuku.SkillDescription;
        evolvedKuku.SkillRange = kuku.SkillRange;
        evolvedKuku.SkillPower = kuku.SkillPower;

        // 提升稀有度或进化等级
        if (canEvolveRarity && effectiveness >= 1.5f)
        {
            evolvedKuku.Rarity = (MythicalKukuData.MythicalRarity)((int)kuku.Rarity + 1);
            evolvedKuku.EvolutionLevel = kuku.EvolutionLevel;
            evolvedKuku.EvolutionProgress = kuku.EvolutionProgress + 0.3f; // 进展加快
        }
        else if (canEvolveLevel)
        {
            evolvedKuku.Rarity = kuku.Rarity;
            evolvedKuku.EvolutionLevel = kuku.EvolutionLevel + 1;
            evolvedKuku.EvolutionProgress = 0f;
        }
        else
        {
            evolvedKuku.Rarity = kuku.Rarity;
            evolvedKuku.EvolutionLevel = kuku.EvolutionLevel;
            evolvedKuku.EvolutionProgress = kuku.EvolutionProgress + effectiveness;
        }

        evolvedKuku.EvolutionStonesRequired = kuku.EvolutionStonesRequired;

        // 增强属性
        evolvedKuku.AttackPower = kuku.AttackPower * (1.0f + effectiveness * 0.1f);
        evolvedKuku.DefensePower = kuku.DefensePower * (1.0f + effectiveness * 0.1f);
        evolvedKuku.Speed = kuku.Speed * (1.0f + effectiveness * 0.05f);
        evolvedKuku.Health = kuku.Health * (1.0f + effectiveness * 0.15f);
        evolvedKuku.DivinePower = kuku.DivinePower * (1.0f + effectiveness * 0.1f);
        evolvedKuku.ProtectionPower = kuku.ProtectionPower * (1.0f + effectiveness * 0.1f);
        evolvedKuku.PurificationPower = kuku.PurificationPower * (1.0f + effectiveness * 0.1f);

        // 检查是否达到最终进化形态
        bool isFinal = evolvedKuku.EvolutionLevel >= 5;

        if (isFinal)
        {
            evolvedKuku.CanFuseWithRobots = true;
        }

        string message = $"灵魂吸收成功！{kuku.Name} 得到了强化！";
        if (isFinal)
        {
            message += " 已达到最终进化形态，可与其他单位融合！";
        }

        return new EvolutionResult(true, evolvedKuku, message, isFinal);
    }
    else
    {
        // 吸收部分灵魂，增加进化进度
        MythicalKukuData updatedKuku = new MythicalKukuData();
        
        // 复制数据
        System.Reflection.PropertyInfo[] properties = typeof(MythicalKukuData).GetProperties();
        foreach (var prop in properties)
        {
            if (prop.CanRead && prop.CanWrite)
            {
                prop.SetValue(updatedKuku, prop.GetValue(kuku));
            }
        }

        // 增加进化进度
        updatedKuku.EvolutionProgress = Mathf.Min(1.0f, kuku.EvolutionProgress + effectiveness * 0.1f);

        string message = $"吸收了灵魂能量，进化进度增加！当前进度: {(int)(updatedKuku.EvolutionProgress * 100)}%";
        return new EvolutionResult(true, updatedKuku, message, IsMaxEvolutionLevel(updatedKuku));
    }
}
```

#### 3.4.3 辅助方法
```csharp
/// <summary>
/// 获取进化成功率
/// </summary>
public static float GetEvolutionSuccessRate(MythicalKukuData kuku)
{
    if (kuku == null) return 0f;

    // 基础成功率
    float baseRate = 0.8f;

    // 根据稀有度调整
    float rarityFactor = 1.0f - ((float)kuku.Rarity / 10f); // 稀有度越高成功率越低

    // 根据进化等级调整
    float levelFactor = 1.0f - (kuku.EvolutionLevel / 10f); // 等级越高成功率越低

    // 根据库库的融合兼容性调整
    float compatibilityFactor = kuku.FusionCompatibility;

    float successRate = baseRate * rarityFactor * levelFactor * compatibilityFactor;

    return Mathf.Clamp01(successRate);
}

/// <summary>
/// 获取进化预览
/// </summary>
public static MythicalKukuData GetEvolutionPreview(MythicalKukuData kuku)
{
    if (kuku == null) return null;

    MythicalKukuData preview = new MythicalKukuData();
    
    // 复制原始数据
    System.Reflection.PropertyInfo[] properties = typeof(MythicalKukuData).GetProperties();
    foreach (var prop in properties)
    {
        if (prop.CanRead && prop.CanWrite)
        {
            prop.SetValue(preview, prop.GetValue(kuku));
        }
    }

    // 模拟进化后的属性提升
    preview.AttackPower *= 1.2f;
    preview.DefensePower *= 1.2f;
    preview.Speed *= 1.1f;
    preview.Health *= 1.25f;
    preview.DivinePower *= 1.15f;
    preview.ProtectionPower *= 1.15f;
    preview.PurificationPower *= 1.15f;

    // 如果不是最高等级，提升稀有度
    if ((int)kuku.Rarity < System.Enum.GetValues(typeof(MythicalKukuData.MythicalRarity)).Length - 1)
    {
        preview.Rarity = (MythicalKukuData.MythicalRarity)((int)kuku.Rarity + 1);
    }

    // 提升进化等级
    preview.EvolutionLevel = kuku.EvolutionLevel + 1;

    return preview;
}

/// <summary>
/// 计算灵魂吸收效果
/// </summary>
public static float CalculateSoulEffectiveness(MythicalKukuData kuku, float soulPower, SoulType soulType)
{
    if (kuku == null) return 0f;

    // 基础效果
    float baseEffect = soulPower * kuku.SoulAbsorptionRate;

    // 根据灵魂类型调整
    float typeMultiplier = 1.0f;
    switch (soulType)
    {
        case SoulType.Common: typeMultiplier = 0.5f; break;
        case SoulType.Rare: typeMultiplier = 0.7f; break;
        case SoulType.Epic: typeMultiplier = 1.0f; break;
        case SoulType.Legendary: typeMultiplier = 1.3f; break;
        case SoulType.Mythic: typeMultiplier = 1.6f; break;
        case SoulType.Divine: typeMultiplier = 2.0f; break;
    }

    // 根据库库当前稀有度调整（高级库库对灵魂利用率更高）
    float rarityMultiplier = 1.0f + (float)kuku.Rarity * 0.1f;

    float effectiveness = baseEffect * typeMultiplier * rarityMultiplier;

    return effectiveness;
}

/// <summary>
/// 检查库库是否已达到最终进化等级
/// </summary>
public static bool IsMaxEvolutionLevel(MythicalKukuData kuku)
{
    if (kuku == null) return false;
    return kuku.EvolutionLevel >= 5; // 假设最高进化等级为5
}

/// <summary>
/// 检查库库是否可以进化
/// </summary>
public static bool CanEvolve(MythicalKukuData kuku)
{
    if (kuku == null) return false;
    
    // 检查是否达到最高进化等级
    if (kuku.EvolutionLevel >= 5) return false;
    
    // 检查是否有足够的灵魂
    if (GameManager.Instance?.PlayerData.Souls < kuku.EvolutionStonesRequired) return false;
    
    return true;
}
```

## 4. 系统交互

### 4.1 数据流
```
PlayerData → EvolutionSystem → Updated KukuData
CaptureSystem → EvolutionSystem → Evolution Result
UI → EvolutionSystem → Evolution Result
```

### 4.2 事件流
- 玩家触发进化 → EvolutionSystem 处理进化逻辑 → 返回进化结果 → UI 更新显示
- kuku获得灵魂 → EvolutionSystem 计算吸收效果 → 更新kuku属性

### 4.3 依赖关系
- EvolutionSystem 依赖 PlayerData 获取玩家资源
- EvolutionSystem 依赖 MythicalKukuData 进行进化计算
- UI系统依赖 EvolutionSystem 获取进化结果