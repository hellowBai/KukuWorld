# 宠物收集塔防游戏《Pet Collector》进化系统设计文档

## 1. 系统概述

进化系统是《Pet Collector》游戏的核心玩法之一，允许玩家通过吸收灵魂来提升宠物的稀有度和能力。该系统特别针对神话宠物设计，使其能够通过吸收野怪灵魂进化，提升稀有度和属性，最终达到可融合的最终形态。

## 2. 系统架构

### 2.1 EvolutionSystem (进化系统)
- **职责**: 管理宠物进化逻辑，处理进化成功率，计算进化后属性
- **类型**: 静态系统类
- **依赖**: MythicalPetData, PlayerData

## 3. EvolutionSystem (进化系统)

### 3.1 类定义
```csharp
public static class EvolutionSystem
```

### 3.2 系统职责
- 处理宠物进化逻辑
- 管理进化成功率
- 计算进化后属性
- 支持灵魂吸收进化机制
- 验证进化条件

### 3.3 数据结构

#### 3.3.1 EvolutionResult (进化结果结构)
```csharp
public struct EvolutionResult
{
    public bool success;
    public MythicalPetData evolvedPet;
    public string message;
    public bool isFinalEvolution;     // 是否达到最终进化等级（可融合）

    public EvolutionResult(bool isSuccess, MythicalPetData pet, string msg, bool isFinal = false)
    {
        success = isSuccess;
        evolvedPet = pet;
        message = msg;
        isFinalEvolution = isFinal;
    }
}
```

#### 3.3.2 灵魂类型枚举
```csharp
public enum SoulType 
{ 
    Common,     // 普通灵魂
    Rare,       // 稀有灵魂
    Epic,       // 史诗灵魂
    Legendary,  // 传说灵魂
    Mythic,     // 神话灵魂
    Divine      // 神圣灵魂
}
```

### 3.4 核心方法

#### 3.4.1 进化方法
```csharp
/// <summary>
/// 尝试进化宠物
/// </summary>
public static EvolutionResult EvolvePet(MythicalPetData pet)
{
    // 检查宠物是否可以进化
    if (pet == null || pet.EvolutionLevel >= 5) // 假设最高进化等级为5
    {
        return new EvolutionResult(false, pet, "宠物已达到最高进化等级！");
    }

    // 检查是否有足够的进化材料
    if (GameManager.Instance?.PlayerData.Souls < pet.EvolutionStonesRequired)
    {
        return new EvolutionResult(false, pet, $"灵魂不足，需要 {pet.EvolutionStonesRequired} 点灵魂");
    }

    // 计算进化成功率
    float successRate = GetEvolutionSuccessRate(pet);

    if (Random.value <= successRate)
    {
        // 进化成功
        MythicalPetData evolvedPet = new MythicalPetData();
        
        // 复制原始数据
        evolvedPet.Id = pet.Id;
        evolvedPet.Name = pet.Name;
        evolvedPet.Description = pet.Description;
        evolvedPet.Element = pet.Element;
        evolvedPet.SkillType = pet.SkillType;
        evolvedPet.SkillDescription = pet.SkillDescription;
        evolvedPet.SkillRange = pet.SkillRange;
        evolvedPet.SkillPower = pet.SkillPower;

        // 提升稀有度
        if ((int)pet.Rarity < System.Enum.GetValues(typeof(MythicalPetData.MythicalRarity)).Length - 1)
        {
            evolvedPet.Rarity = (MythicalPetData.MythicalRarity)((int)pet.Rarity + 1);
        }
        else
        {
            evolvedPet.Rarity = pet.Rarity;
        }

        // 提升进化等级
        evolvedPet.EvolutionLevel = pet.EvolutionLevel + 1;
        evolvedPet.EvolutionProgress = 0f;
        evolvedPet.EvolutionStonesRequired = pet.EvolutionStonesRequired + 10; // 每级增加10点需求

        // 增强属性
        evolvedPet.AttackPower = pet.AttackPower * 1.2f;
        evolvedPet.DefensePower = pet.DefensePower * 1.2f;
        evolvedPet.Speed = pet.Speed * 1.1f;
        evolvedPet.Health = pet.Health * 1.25f;
        evolvedPet.DivinePower = pet.DivinePower * 1.15f;
        evolvedPet.ProtectionPower = pet.ProtectionPower * 1.15f;
        evolvedPet.PurificationPower = pet.PurificationPower * 1.15f;

        // 检查是否达到最终进化形态（可融合）
        bool isFinal = evolvedPet.EvolutionLevel >= 5;

        // 消耗灵魂
        if (GameManager.Instance?.PlayerData != null)
        {
            GameManager.Instance.PlayerData.AddSouls(-pet.EvolutionStonesRequired);
        }

        string message = $"进化成功！{pet.Name} 进化为 {evolvedPet.Rarity} 级别！";
        if (isFinal)
        {
            message += " 已达到最终进化形态，可与其他单位融合！";
            evolvedPet.CanFuseWithRobots = true;
        }

        return new EvolutionResult(true, evolvedPet, message, isFinal);
    }
    else
    {
        // 进化失败，消耗一半的灵魂
        if (GameManager.Instance?.PlayerData != null)
        {
            GameManager.Instance.PlayerData.AddSouls(-pet.EvolutionStonesRequired / 2);
        }

        return new EvolutionResult(false, pet, "进化失败！消耗了一半的灵魂。");
    }
}
```

#### 3.4.2 通过灵魂吸收进化方法
```csharp
/// <summary>
/// 通过吸收灵魂进化宠物
/// </summary>
public static EvolutionResult EvolvePetWithSoul(MythicalPetData pet, float soulPower, SoulType soulType)
{
    if (pet == null)
    {
        return new EvolutionResult(false, pet, "无效的宠物数据！");
    }

    // 检查宠物是否可以吸收灵魂
    if (!pet.CanAbsorbSoul)
    {
        return new EvolutionResult(false, pet, "该宠物无法吸收灵魂！");
    }

    // 计算灵魂吸收效果
    float effectiveness = CalculateSoulEffectiveness(pet, soulPower, soulType);

    // 根据灵魂类型调整成功率
    float multiplier = 1.0f;
    switch (soulType)
    {
        case SoulType.Common: multiplier = 0.5f; break;
        case SoulType.Rare: multiplier = 0.7f; break;
        case SoulType.Epic: multiplier = 1.0f; break;
        case SoulType.Legendary: multiplier = 1.3f; break;
        case SoulType.Mythic: multiplier = 1.6f; break;
        case SoulType.Divine: multiplier = 2.0f; break;
    }

    effectiveness *= multiplier;

    // 检查是否能进化到下一个稀有度
    bool canEvolveRarity = (int)pet.Rarity < System.Enum.GetValues(typeof(MythicalPetData.MythicalRarity)).Length - 1;
    bool canEvolveLevel = pet.EvolutionLevel < 5;

    if (effectiveness >= 1.0f && (canEvolveRarity || canEvolveLevel))
    {
        // 成功进化
        MythicalPetData evolvedPet = new MythicalPetData();
        
        // 复制原始数据
        evolvedPet.Id = pet.Id;
        evolvedPet.Name = pet.Name;
        evolvedPet.Description = pet.Description;
        evolvedPet.Element = pet.Element;
        evolvedPet.SkillType = pet.SkillType;
        evolvedPet.SkillDescription = pet.SkillDescription;
        evolvedPet.SkillRange = pet.SkillRange;
        evolvedPet.SkillPower = pet.SkillPower;

        // 提升稀有度或进化等级
        if (canEvolveRarity && effectiveness >= 1.5f)
        {
            evolvedPet.Rarity = (MythicalPetData.MythicalRarity)((int)pet.Rarity + 1);
            evolvedPet.EvolutionLevel = pet.EvolutionLevel;
            evolvedPet.EvolutionProgress = pet.EvolutionProgress + 0.3f; // 进展加快
        }
        else if (canEvolveLevel)
        {
            evolvedPet.Rarity = pet.Rarity;
            evolvedPet.EvolutionLevel = pet.EvolutionLevel + 1;
            evolvedPet.EvolutionProgress = 0f;
        }
        else
        {
            evolvedPet.Rarity = pet.Rarity;
            evolvedPet.EvolutionLevel = pet.EvolutionLevel;
            evolvedPet.EvolutionProgress = pet.EvolutionProgress + effectiveness;
        }

        evolvedPet.EvolutionStonesRequired = pet.EvolutionStonesRequired;

        // 增强属性
        evolvedPet.AttackPower = pet.AttackPower * (1.0f + effectiveness * 0.1f);
        evolvedPet.DefensePower = pet.DefensePower * (1.0f + effectiveness * 0.1f);
        evolvedPet.Speed = pet.Speed * (1.0f + effectiveness * 0.05f);
        evolvedPet.Health = pet.Health * (1.0f + effectiveness * 0.15f);
        evolvedPet.DivinePower = pet.DivinePower * (1.0f + effectiveness * 0.1f);
        evolvedPet.ProtectionPower = pet.ProtectionPower * (1.0f + effectiveness * 0.1f);
        evolvedPet.PurificationPower = pet.PurificationPower * (1.0f + effectiveness * 0.1f);

        // 检查是否达到最终进化形态
        bool isFinal = evolvedPet.EvolutionLevel >= 5;

        if (isFinal)
        {
            evolvedPet.CanFuseWithRobots = true;
        }

        string message = $"灵魂吸收成功！{pet.Name} 得到了强化！";
        if (isFinal)
        {
            message += " 已达到最终进化形态，可与其他单位融合！";
        }

        return new EvolutionResult(true, evolvedPet, message, isFinal);
    }
    else
    {
        // 吸收部分灵魂，增加进化进度
        MythicalPetData updatedPet = new MythicalPetData();
        
        // 复制数据
        System.Reflection.PropertyInfo[] properties = typeof(MythicalPetData).GetProperties();
        foreach (var prop in properties)
        {
            if (prop.CanRead && prop.CanWrite)
            {
                prop.SetValue(updatedPet, prop.GetValue(pet));
            }
        }

        // 增加进化进度
        updatedPet.EvolutionProgress = Mathf.Min(1.0f, pet.EvolutionProgress + effectiveness * 0.1f);

        string message = $"吸收了灵魂能量，进化进度增加！当前进度: {(int)(updatedPet.EvolutionProgress * 100)}%";
        return new EvolutionResult(true, updatedPet, message, IsMaxEvolutionLevel(updatedPet));
    }
}
```

#### 3.4.3 辅助方法
```csharp
/// <summary>
/// 获取进化成功率
/// </summary>
public static float GetEvolutionSuccessRate(MythicalPetData pet)
{
    if (pet == null) return 0f;

    // 基础成功率
    float baseRate = 0.8f;

    // 根据稀有度调整
    float rarityFactor = 1.0f - ((float)pet.Rarity / 10f); // 稀有度越高成功率越低

    // 根据进化等级调整
    float levelFactor = 1.0f - (pet.EvolutionLevel / 10f); // 等级越高成功率越低

    // 根据宠物的融合兼容性调整
    float compatibilityFactor = pet.FusionCompatibility;

    float successRate = baseRate * rarityFactor * levelFactor * compatibilityFactor;

    return Mathf.Clamp01(successRate);
}

/// <summary>
/// 获取进化预览
/// </summary>
public static MythicalPetData GetEvolutionPreview(MythicalPetData pet)
{
    if (pet == null) return null;

    MythicalPetData preview = new MythicalPetData();
    
    // 复制原始数据
    System.Reflection.PropertyInfo[] properties = typeof(MythicalPetData).GetProperties();
    foreach (var prop in properties)
    {
        if (prop.CanRead && prop.CanWrite)
        {
            prop.SetValue(preview, prop.GetValue(pet));
        }
    }

    // 模拟进化后的属性提升
    preview.AttackPower *= 1.2f;
    preview.DefensePower *= 1.2f;
    preview.Speed *= 1.1f;
    preview.Health *= 1.25f;
    preview.DivinePower *= 1.15f;
    preview.ProtectionPower *= 1.15f;
    preview.PurificationPower *= 1.15f;

    // 如果不是最高等级，提升稀有度
    if ((int)pet.Rarity < System.Enum.GetValues(typeof(MythicalPetData.MythicalRarity)).Length - 1)
    {
        preview.Rarity = (MythicalPetData.MythicalRarity)((int)pet.Rarity + 1);
    }

    // 提升进化等级
    preview.EvolutionLevel = pet.EvolutionLevel + 1;

    return preview;
}

/// <summary>
/// 计算灵魂吸收效果
/// </summary>
public static float CalculateSoulEffectiveness(MythicalPetData pet, float soulPower, SoulType soulType)
{
    if (pet == null) return 0f;

    // 基础效果
    float baseEffect = soulPower * pet.SoulAbsorptionRate;

    // 根据灵魂类型调整
    float typeMultiplier = 1.0f;
    switch (soulType)
    {
        case SoulType.Common: typeMultiplier = 0.5f; break;
        case SoulType.Rare: typeMultiplier = 0.7f; break;
        case SoulType.Epic: typeMultiplier = 1.0f; break;
        case SoulType.Legendary: typeMultiplier = 1.3f; break;
        case SoulType.Mythic: typeMultiplier = 1.6f; break;
        case SoulType.Divine: typeMultiplier = 2.0f; break;
    }

    // 根据宠物当前稀有度调整（高级宠物对灵魂利用率更高）
    float rarityMultiplier = 1.0f + (float)pet.Rarity * 0.1f;

    float effectiveness = baseEffect * typeMultiplier * rarityMultiplier;

    return effectiveness;
}

/// <summary>
/// 检查宠物是否已达到最终进化等级
/// </summary>
public static bool IsMaxEvolutionLevel(MythicalPetData pet)
{
    if (pet == null) return false;
    return pet.EvolutionLevel >= 5; // 假设最高进化等级为5
}

/// <summary>
/// 检查宠物是否可以进化
/// </summary>
public static bool CanEvolve(MythicalPetData pet)
{
    if (pet == null) return false;
    
    // 检查是否达到最高进化等级
    if (pet.EvolutionLevel >= 5) return false;
    
    // 检查是否有足够的灵魂
    if (GameManager.Instance?.PlayerData.Souls < pet.EvolutionStonesRequired) return false;
    
    return true;
}
```

## 4. 系统交互

### 4.1 数据流
```
PlayerData → EvolutionSystem → Updated PetData
CaptureSystem → EvolutionSystem → Evolution Result
UI → EvolutionSystem → Evolution Result
```

### 4.2 事件流
- 玩家触发进化 → EvolutionSystem 处理进化逻辑 → 返回进化结果 → UI 更新显示
- 宠物获得灵魂 → EvolutionSystem 计算吸收效果 → 更新宠物属性

### 4.3 依赖关系
- EvolutionSystem 依赖 PlayerData 获取玩家资源
- EvolutionSystem 依赖 MythicalPetData 进行进化计算
- UI系统依赖 EvolutionSystem 获取进化结果