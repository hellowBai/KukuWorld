# Kuku收集塔防游戏《Kuku Collector》捕捉系统设计文档

## 1. 系统概述

捕捉系统是《Kuku Collector》游戏的核心玩法之一，专为"前5分钟捕捉→后续防守"的独特机制设计。玩家在前5分钟内捕捉野生kuku，每只野怪死亡后会掉落灵魂、金钱和kuku蛋。初级kuku拥有吸收核心灵魂的技能，有概率让kuku进化。系统包含野外kuku生成、限时捕捉机制、灵魂吸收、掉落物生成等子系统。

## 2. 系统架构

### 2.1 CaptureSystem (捕捉系统)
- **职责**: 管理捕捉核心逻辑，处理限时捕捉和灵魂吸收
- **类型**: 静态系统类
- **依赖**: PlayerData, MythicalKukuData

### 2.2 ExplorationSystem (探索系统)
- **职责**: 管理地图探索和kuku生成，控制5分钟捕捉期的刷新机制
- **类型**: 单例系统
- **依赖**: CaptureSystem, PlayerData

### 2.3 CaptureUI (捕捉界面)
- **职责**: 提供捕捉操作的用户界面，显示捕捉阶段倒计时
- **类型**: UI控制器
- **依赖**: CaptureSystem, ExplorationSystem

## 3. CaptureSystem (捕捉系统)

### 3.1 类定义
```csharp
public static class CaptureSystem
```

### 3.2 系统职责
- 管理野外神宠数据
- 处理捕捉逻辑和成功率计算
- 管理捕捉过程中的削弱机制
- 处理灵魂吸收进化机制
- 生成野怪死亡后的掉落物（灵魂、金钱、kuku蛋）
- 提供捕捉相关的查询接口

### 3.3 数据结构

#### 3.3.1 WildKuku (野外kuku结构)
```csharp
public struct WildKuku
{
    public MythicalKukuData kukuData;    // kuku数据
    public Vector3 position;          // 位置坐标
    public float remainingHP;         // 剩余生命值
    public bool isCapturable;         // 是否可捕捉
    public float timeUntilDespawn;    // 消失倒计时
    public bool isSoulAbsorbing;      // 是否正在吸收灵魂
    public float soulAccumulated;     // 已积累的灵魂值
    
    public WildKuku(MythicalKukuData kuku, Vector3 pos)
    {
        kukuData = kuku;
        position = pos;
        remainingHP = kuku.Health;
        isCapturable = false; // 初始不可捕捉，需要削弱后才能捕捉
        timeUntilDespawn = 300f; // 5分钟内必须捕捉，否则消失
        isSoulAbsorbing = false;
        soulAccumulated = 0f;
    }
}
```

#### 3.3.2 CaptureResult (捕捉结果结构)
```csharp
public struct CaptureResult
{
    public bool success;              // 捕捉是否成功
    public MythicalKukuData capturedKuku; // 捕获的kuku数据
    public string message;            // 结果消息
    public List<ItemDrop> drops;      // 捕捉成功后的掉落物
    
    public CaptureResult(bool isSuccess, MythicalKukuData kuku, string msg, List<ItemDrop> dropList = null)
    {
        success = isSuccess;
        capturedKuku = kuku;
        message = msg;
        drops = dropList ?? new List<ItemDrop>();
    }
}
```

#### 3.3.3 ItemDrop (掉落物结构)
```csharp
public struct ItemDrop
{
    public ItemType type;             // 掉落物类型
    public float value;               // 数值
    public int quantity;              // 数量
    
    public enum ItemType { Soul, Coin, KukuEgg, Resource }
    
    public ItemDrop(ItemType t, float val, int qty)
    {
        type = t;
        value = val;
        quantity = qty;
    }
}
```

### 3.4 核心方法

#### 3.4.1 野外库库生成方法
```csharp
/// <summary>
/// 生成野外库库
/// </summary>
public static void GenerateWildKuku(Vector3 position, MythicalKukuData.MythicalRarity rarity = MythicalKukuData.MythicalRarity.Celestial)
{
    try
    {
        // 创建野生库库数据
        MythicalKukuData wildKuku = new MythicalKukuData();
        wildKuku.Id = UnityEngine.Random.Range(1000, 9999); // 随机ID
        wildKuku.Name = GenerateWildKukuName(rarity);
        wildKuku.Rarity = rarity;
        wildKuku.Description = "在野外游荡的库库";
        wildKuku.SpriteName = $"WildKuku_{wildKuku.Id}";
        
        // 设置基础属性
        wildKuku.AttackPower = 30f + (int)rarity * 20f;
        wildKuku.DefensePower = 20f + (int)rarity * 15f;
        wildKuku.Speed = 2f + (int)rarity * 0.5f;
        wildKuku.Health = 100f + (int)rarity * 50f;
        
        // 设置神话属性
        wildKuku.DivinePower = 20f + (int)rarity * 15f;
        wildKuku.ProtectionPower = 15f + (int)rarity * 10f;
        wildKuku.PurificationPower = 10f + (int)rarity * 8f;
        
        // 设置捕捉相关属性
        wildKuku.CaptureDifficulty = 1.0f - (float)rarity * 0.1f; // 稀有度越高越难捕捉
        wildKuku.CanAbsorbSoul = true;
        wildKuku.SoulAbsorptionRate = 0.5f + (int)rarity * 0.1f;
        
        // 创建野外库库对象
        WildKuku wild = new WildKuku(wildKuku, position);
        
        Debug.Log($"在位置 {position} 生成了野生库库: {wildKuku.Name}");
    }
    catch (Exception e)
    {
        Debug.LogError($"生成野外库库时发生错误: {e.Message}");
    }
}
```

#### 3.4.2 攻击削弱方法
```csharp
/// <summary>
/// 攻击野生库库（削弱其生命值以达到捕捉条件）
/// </summary>
public static bool AttackWildKuku(int kukuId, float damage, out string message)
{
    message = "";
    
    // 这里应该维护一个野生库库列表，实际实现中需要管理这个列表
    // 暂时返回模拟结果
    
    message = "野生库库受到攻击，生命值降低";
    return true; // 返回是否可以捕捉（生命值降低后可能达到捕捉条件）
}
```

#### 3.4.3 捕捉核心方法
```csharp
/// <summary>
/// 尝试捕捉野生库库
/// </summary>
public static CaptureResult AttemptCapture(int kukuId, MythicalKukuData capturerKuku = null)
{
    // 这里应该从野生库库列表中找到指定的库库
    // 暂时返回模拟结果
    
    MythicalKukuData capturedKuku = new MythicalKukuData();
    capturedKuku.Id = kukuId;
    capturedKuku.Name = "被捕捉的库库";
    capturedKuku.Rarity = MythicalKukuData.MythicalRarity.Celestial;
    
    // 生成掉落物
    List<ItemDrop> drops = new List<ItemDrop>();
    
    // 固定掉落：金币
    drops.Add(new ItemDrop(ItemDrop.ItemType.Coin, 0, UnityEngine.Random.Range(10, 50)));
    
    // 随机掉落：灵魂
    if (UnityEngine.Random.value < 0.7f)
    {
        drops.Add(new ItemDrop(ItemDrop.ItemType.Soul, 
            (float)UnityEngine.Random.Range(1, 5), 1));
    }
    
    // 随机掉落：库库蛋
    if (UnityEngine.Random.value < 0.2f)
    {
        drops.Add(new ItemDrop(ItemDrop.ItemType.KukuEgg, 0, 1));
    }
    
    string message = $"成功捕捉到 {capturedKuku.Name}！获得了资源奖励。";
    
    return new CaptureResult(true, capturedKuku, message, drops);
}
```

#### 3.4.4 辅助方法
```csharp
/// <summary>
/// 生成野生库库名称
/// </summary>
private static string GenerateWildKukuName(MythicalKukuData.MythicalRarity rarity)
{
    string[] prefixes = { "荒野", "山林", "湖畔", "洞穴", "天空", "深海", "幽谷", "高峰", "古树", "灵泉" };
    string[] middles = { "守护", "游荡", "隐居", "觅食", "嬉戏", "修炼", "沉睡", "觉醒", "飞翔", "漫步" };
    string[] suffixes = { "精灵", "仙子", "神使", "圣兽", "灵童", "天将", "护法", "使者", "神童", "灵君" };
    
    string prefix = prefixes[UnityEngine.Random.Range(0, prefixes.Length)];
    string middle = middles[UnityEngine.Random.Range(0, middles.Length)];
    string suffix = suffixes[UnityEngine.Random.Range(0, suffixes.Length)];
    
    return prefix + middle + suffix;
}

/// <summary>
/// 获取捕捉成功率
/// </summary>
public static float GetCaptureSuccessRate(int kukuId, MythicalKukuData capturerKuku = null)
{
    // 实际实现中需要根据库库稀有度、生命值比例、捕捉者库库等因素计算
    return 0.7f; // 模拟成功率
}

/// <summary>
/// 检查指定位置是否有野生库库
/// </summary>
public static bool HasWildKukuAtPosition(Vector3 position, float radius = 1.0f)
{
    // 实际实现中需要检查野生库库列表
    return false;
}
```

## 4. ExplorationSystem (探索系统)

### 4.1 类定义
```csharp
public class ExplorationSystem : MonoBehaviour
```

### 4.2 系统职责
- 管理地图探索区域
- 控制神宠随机生成
- 处理探索事件
- 管理5分钟捕捉期内的刷新机制

### 4.3 数据结构

#### 4.3.1 配置参数
```csharp
[Header("探索设置")]
public float explorationAreaSize = 20f;       // 探索区域大小
public int maxWildPets = 10;                  // 最大野外神宠数量
public float wildPetRespawnTime = 30f;        // 重生时间（秒）
public float explorationCheckInterval = 5f;   // 探索检查间隔
public float capturePhaseDuration = 300f;     // 捕捉阶段持续时间(5分钟)

// 探索区域边界
private Bounds explorationBounds;

// 捕捉阶段控制
private float timeInCapturePhase = 0f;        // 捕捉阶段已进行时间
private bool capturePhaseActive = true;       // 捕捉阶段是否激活
```

#### 4.3.2 事件系统
```csharp
// 事件系统
public event Action<Vector3> OnWildPetSpotted;  // 发现野生神宠事件
public event Action<string> OnExplorationEvent;  // 探索事件
public event Action OnCapturePhaseEnded;         // 捕捉阶段结束事件
public event Action OnDefensePhaseStarted;       // 防守阶段开始事件
```

### 4.4 核心方法

#### 4.4.1 初始化方法
```csharp
/// <summary>
/// 初始化探索系统
/// </summary>
private void InitializeExplorationSystem()
{
    // 设置探索边界
    explorationBounds = new Bounds(Vector3.zero, new Vector3(explorationAreaSize, 1f, explorationAreaSize));
    
    Debug.Log("探索系统初始化完成");
}
```

#### 4.4.2 更新方法
```csharp
private void Update()
{
    if (capturePhaseActive)
    {
        // 更新捕捉阶段时间
        timeInCapturePhase += Time.deltaTime;
        
        // 检查是否超过捕捉阶段时间
        if (timeInCapturePhase >= capturePhaseDuration)
        {
            EndCapturePhase();
        }
        
        // 定期检查是否需要生成新的野生库库
        CheckAndRespawnWildKukus();
    }
}
```

#### 4.4.3 重生管理方法
```csharp
/// <summary>
/// 检查并重生野生库库
/// </summary>
private void CheckAndRespawnWildKukus()
{
    // 这里应该检查当前野外库库数量并生成新的
    // 根据捕捉阶段的时间推移，逐渐提高生成的库库稀有度
    
    float timeRatio = timeInCapturePhase / capturePhaseDuration;
    
    // 根据时间比例调整稀有度
    MythicalKukuData.MythicalRarity rarity = GetRarityBasedOnTime(timeRatio);
    
    // 随机生成位置
    Vector3 randomPos = GetRandomExplorationPosition();
    
    // 检查该位置是否已经有库库
    if (!CaptureSystem.HasWildKukuAtPosition(randomPos, 2f))
    {
        CaptureSystem.GenerateWildKuku(randomPos, rarity);
        
        // 通知发现野生库库
        OnWildKukuSpotted?.Invoke(randomPos);
        
        Debug.Log($"在位置 {randomPos} 生成了野生库库");
    }
}

/// <summary>
/// 根据时间比例获取稀有度
/// </summary>
private MythicalKukuData.MythicalRarity GetRarityBasedOnTime(float timeRatio)
{
    if (timeRatio < 0.2f) // 前20%时间
        return MythicalKukuData.MythicalRarity.Celestial;
    else if (timeRatio < 0.4f) // 20%-40%时间
        return MythicalKukuData.MythicalRarity.Immortal;
    else if (timeRatio < 0.6f) // 40%-60%时间
        return MythicalKukuData.MythicalRarity.DivineBeast;
    else if (timeRatio < 0.8f) // 60%-80%时间
        return MythicalKukuData.MythicalRarity.Sacred;
    else // 最后20%时间
        return MythicalKukuData.MythicalRarity.Primordial;
}

/// <summary>
/// 获取随机探索位置
/// </summary>
private Vector3 GetRandomExplorationPosition()
{
    float x = UnityEngine.Random.Range(-explorationAreaSize / 2, explorationAreaSize / 2);
    float z = UnityEngine.Random.Range(-explorationAreaSize / 2, explorationAreaSize / 2);
    
    return new Vector3(x, 0, z);
}
```

#### 4.4.4 阶段控制方法
```csharp
/// <summary>
/// 开始捕捉阶段
/// </summary>
public void StartCapturePhase()
{
    capturePhaseActive = true;
    timeInCapturePhase = 0f;
    
    Debug.Log("捕捉阶段开始，快去捕捉野生库库！");
}

/// <summary>
/// 结束捕捉阶段，开始防守阶段
/// </summary>
public void StartDefensePhase()
{
    capturePhaseActive = false;
    
    // 通知相关系统
    OnCapturePhaseEnded?.Invoke();
    
    Debug.Log("捕捉阶段结束，进入防守阶段！");
}

/// <summary>
/// 结束捕捉阶段
/// </summary>
private void EndCapturePhase()
{
    StartDefensePhase();
}

/// <summary>
/// 检查是否仍在捕捉阶段
/// </summary>
public bool IsInCapturePhase()
{
    return capturePhaseActive && timeInCapturePhase < capturePhaseDuration;
}
```

#### 4.4.5 查询方法
```csharp
/// <summary>
/// 获取探索区域信息
/// </summary>
public (Bounds bounds, int currentPets, int maxPets, float timeRemaining) GetExplorationInfo()
{
    float timeRemaining = Mathf.Max(0, capturePhaseDuration - timeInCapturePhase);
    int currentPets = 0; // 这里应该返回实际的野生神宠数量
    
    return (explorationBounds, currentPets, maxWildPets, timeRemaining);
}
```

## 5. CaptureUI (捕捉界面)

### 5.1 类定义
```csharp
public class CaptureUI : MonoBehaviour
```

### 5.2 系统职责
- 显示野外kuku信息
- 处理捕捉操作界面
- 管理捕捉状态显示
- 显示捕捉阶段倒计时

### 5.3 数据结构

#### 5.3.1 界面组件
```csharp
[Header("捕捉面板")]
public GameObject capturePanel;                    // 捕捉面板
public Button closeCaptureButton;                   // 关闭按钮

[Header("野外kuku显示")]
public Transform wildKukuContainer;                  // 野外kuku容器
public GameObject wildKukuCardPrefab;                // 野外kuku卡片预制体

[Header("捕捉信息显示")]
public TextMeshProUGUI selectedKukuNameText;         // 选中kuku名称
public TextMeshProUGUI selectedKukuRarityText;       // 选中kuku稀有度
public TextMeshProUGUI selectedKukuHpText;           // 选中kuku生命值
public Slider selectedKukuHpSlider;                  // 选中kuku生命值滑动条
public TextMeshProUGUI captureStatusText;           // 捕捉状态
public TextMeshProUGUI captureSuccessRateText;      // 捕捉成功率

[Header("攻击选项")]
public Button attackButton;                         // 攻击按钮
public Button useKukuAttackButton;                   // 使用kuku攻击按钮
public TextMeshProUGUI attackPowerText;             // 攻击强度显示

[Header("捕捉选项")]
public Button captureButton;                        // 捕捉按钮
public Button useSpecialCaptureButton;              // 使用特殊捕捉按钮

[Header("捕捉阶段倒计时")]
public TextMeshProUGUI capturePhaseTimerText;       // 捕捉阶段倒计时显示
```

#### 5.3.2 状态数据
```csharp
private CaptureSystem.WildKuku? selectedWildKuku;     // 选中的野外kuku
private MythicalKukuData selectedCapturerKuku;        // 选中的捕捉者kuku
private float timeRemainingInCapturePhase = 300f;   // 捕捉阶段剩余时间
```

### 5.4 核心方法

#### 5.4.1 初始化方法
```csharp
/// <summary>
/// 初始化UI
/// </summary>
private void InitializeUI()
{
    if (capturePanel != null)
        capturePanel.SetActive(false);
    
    if (closeCaptureButton != null)
        closeCaptureButton.onClick.AddListener(CloseCapturePanel);
    
    if (attackButton != null)
        attackButton.onClick.AddListener(() => AttackSelectedWildKuku(false));
    
    if (useKukuAttackButton != null)
        useKukuAttackButton.onClick.AddListener(() => AttackSelectedWildKuku(true));
    
    if (captureButton != null)
        captureButton.onClick.AddListener(() => AttemptCaptureSelectedKuku(false));
    
    if (useSpecialCaptureButton != null)
        useSpecialCaptureButton.onClick.AddListener(() => AttemptCaptureSelectedKuku(true));
}
```

#### 5.4.2 界面控制方法
```csharp
/// <summary>
/// 打开捕捉面板
/// </summary>
public void OpenCapturePanel()
{
    if (capturePanel != null)
        capturePanel.SetActive(true);
    
    RefreshWildPetList();
}

/// <summary>
/// 关闭捕捉面板
/// </summary>
public void CloseCapturePanel()
{
    if (capturePanel != null)
        capturePanel.SetActive(false);
    
    selectedWildKuku = null;
    selectedCapturerKuku = null;
}
```

#### 5.4.3 野外神宠显示方法
```csharp
/// <summary>
/// 刷新野外库库列表
/// </summary>
public void RefreshWildKukuList()
{
    if (wildKukuContainer == null || wildKukuCardPrefab == null) return;
    
    // 清除现有卡片
    ClearWildKukuCards();
    
    // 这里应该从CaptureSystem获取野外库库列表
    // 暂时创建模拟数据
    
    Debug.Log("刷新野外库库列表");
}

/// <summary>
/// 清除野外库库卡片
/// </summary>
private void ClearWildKukuCards()
{
    foreach (Transform child in wildKukuContainer)
    {
        DestroyImmediate(child.gameObject);
    }
}
```

#### 5.4.4 倒计时更新方法
```csharp
/// <summary>
/// 更新捕捉阶段倒计时显示
/// </summary>
public void UpdateCaptureTimerDisplay(float timeRemaining)
{
    if (capturePhaseTimerText != null)
    {
        int minutes = Mathf.FloorToInt(timeRemaining / 60);
        int seconds = Mathf.RoundToInt(timeRemaining % 60);
        
        capturePhaseTimerText.text = $"捕捉时间: {minutes:D2}:{seconds:D2}";
        
        // 根据剩余时间改变颜色（时间紧张时变红）
        if (timeRemaining < 60)
        {
            capturePhaseTimerText.color = Color.red;
        }
        else if (timeRemaining < 120)
        {
            capturePhaseTimerText.color = Color.yellow;
        }
        else
        {
            capturePhaseTimerText.color = Color.green;
        }
    }
}

/// <summary>
/// 显示捕捉阶段结束提示
/// </summary>
public void ShowCapturePhaseEnding()
{
    Debug.Log("捕捉阶段即将结束，请尽快捕捉更多KuKu！");
}
```

#### 5.4.5 按钮状态管理方法
```csharp
/// <summary>
/// 更新按钮可用性
/// </summary>
private void UpdateButtonAvailability()
{
    bool hasSelectedPet = selectedWildPet.HasValue;
    
    if (attackButton != null)
        attackButton.interactable = hasSelectedPet;
    
    if (usePetAttackButton != null)
        usePetAttackButton.interactable = hasSelectedPet && selectedCapturerPet != null;
    
    if (captureButton != null)
        captureButton.interactable = hasSelectedPet && selectedWildPet.Value.isCapturable;
    
    if (useSpecialCaptureButton != null)
        useSpecialCaptureButton.interactable = hasSelectedPet && selectedWildPet.Value.isCapturable;
}
```

## 6. 系统交互

### 6.1 数据流
```
ExplorationSystem → CaptureSystem → WildKuku data
CaptureUI → CaptureSystem → Capture result
CaptureSystem → PlayerData → Resource rewards
ExplorationSystem → GameManager → Phase transition
```

### 6.2 事件流
- ExplorationSystem 触发 OnWildKukuSpotted → UI 显示新kuku
- CaptureUI 触发捕捉操作 → CaptureSystem 处理结果
- CaptureSystem 捕捉成功 → PlayerData 添加kuku和资源
- ExplorationSystem 时间结束 → GameManager 切换到防守阶段

### 6.3 依赖关系
- CaptureUI 依赖 CaptureSystem 获取数据
- ExplorationSystem 依赖 CaptureSystem 管理kuku
- 捕捉结果影响 PlayerData 和 UI 显示
- 阶段转换由 ExplorationSystem 控制