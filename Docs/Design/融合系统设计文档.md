# Kuku收集塔防游戏《Kuku Collector》融合系统设计文档

## 1. 系统概述

融合系统是《Kuku Collector》游戏的核心玩法之一，允许玩家将进化到最终等级的kuku与特定机器人进行融合，创造出更强大的终极单位。融合后的单位可以装备六件装备，大幅提升战斗力。

## 2. 系统架构

### 2.1 FusionSystem (融合系统)
- **职责**: 处理各类融合逻辑，管理融合配方，计算融合结果
- **类型**: 静态系统类
- **依赖**: MythicalKukuData, UnitData, PlayerData

## 3. FusionSystem (融合系统)

### 3.1 类定义
```csharp
public static class FusionSystem
```

### 3.2 系统职责
- 处理各类融合逻辑
- 管理融合配方
- 计算融合结果
- 特别处理KuKu与机器人的融合
- 验证融合条件

### 3.3 数据结构

#### 3.3.1 融合结果结构
```csharp
public struct FusionResult
{
    public bool success;
    public object fusedObject;
    public string message;
    public int equipmentSlots;        // 融合后可用的装备槽位数（通常是6个）
    
    public FusionResult(bool isSuccess, object obj, string msg, int slots = 0)
    {
        success = isSuccess;
        fusedObject = obj;
        message = msg;
        equipmentSlots = slots;
    }
}
```

#### 3.3.2 融合配方结构
```csharp
public struct FusionRecipe
{
    public string resultName;
    public int fusionCost;
    public string description;
    public FusionType type;                               // 融合类型
    public int maxEquipmentSlots;                         // 融合后装备槽数量
    
    public enum FusionType 
    { 
        KukuRobot,                                        // kuku+机器人
        RobotRobot,                                       // 机器人+机器人
        KukuKuku,                                         // kuku+kuku
        UnitUnit                                          // 单位+单位
    }
    
    public FusionRecipe(string name, int cost, string desc, FusionType ft, int slots)
    {
        resultName = name;
        fusionCost = cost;
        description = desc;
        type = ft;
        maxEquipmentSlots = slots;
    }
}
```

#### 3.3.3 融合配置
```csharp
public static class FusionConfig
{
    // kuku与机器人融合的装备槽位数
    public const int KUKU_ROBOT_FUSION_EQUIPMENT_SLOTS = 6;
    
    // 机器人与机器人融合的装备槽位数
    public const int ROBOT_ROBOT_FUSION_EQUIPMENT_SLOTS = 4;
    
    // kuku与kuku融合的装备槽位数
    public const int KUKU_KUKU_FUSION_EQUIPMENT_SLOTS = 3;
    
    // 单位与单位融合的装备槽位数
    public const int UNIT_UNIT_FUSION_EQUIPMENT_SLOTS = 5;
}
```

### 3.4 核心方法

#### 3.4.1 融合方法
```csharp
/// <summary>
/// 尝试融合两个对象
/// </summary>
public static FusionResult FuseObjects(object obj1, object obj2)
{
    // 检查输入参数
    if (obj1 == null || obj2 == null)
    {
        return new FusionResult(false, null, "融合对象不能为空！");
    }

    // 根据对象类型执行相应的融合逻辑
    if (obj1 is MythicalKukuData && obj2 is UnitData)
    {
        return FuseKukuWithRobot((MythicalKukuData)obj1, (UnitData)obj2);
    }
    else if (obj1 is UnitData && obj2 is MythicalKukuData)
    {
        return FuseKukuWithRobot((MythicalKukuData)obj2, (UnitData)obj1);
    }
    else if (obj1 is UnitData && obj2 is UnitData)
    {
        return FuseUnits((UnitData)obj1, (UnitData)obj2);
    }
    else if (obj1 is MythicalKukuData && obj2 is MythicalKukuData)
    {
        return FuseKukus((MythicalKukuData)obj1, (MythicalKukuData)obj2);
    }
    else
    {
        return new FusionResult(false, null, "不支持的融合组合！");
    }
}
```

#### 3.4.2 KuKu与机器人融合方法
```csharp
/// <summary>
/// kuku与机器人融合
/// </summary>
public static FusionResult FuseKukuWithRobot(MythicalKukuData kuku, UnitData robot)
{
    // 检查融合条件
    if (kuku == null || robot == null)
    {
        return new FusionResult(false, null, "融合对象不能为空！");
    }

    // 检查kuku是否达到最终进化等级
    if (kuku.EvolutionLevel < 5)
    {
        return new FusionResult(false, null, "kuku需要进化到第5级才能融合！");
    }

    // 检查机器人是否达到最高等级
    if (robot.Level < 10)
    {
        return new FusionResult(false, null, "机器人需要达到10级才能融合！");
    }

    // 检查融合兼容性
    if (kuku.FusionCompatibility < 0.5f)
    {
        return new FusionResult(false, null, "kuku融合兼容性不足！");
    }

    // 检查玩家是否有足够资源
    if (GameManager.Instance?.PlayerData.Souls < 50)
    {
        return new FusionResult(false, null, "灵魂不足，需要50点灵魂进行融合！");
    }

    // 检查机器人是否可融合
    if (!robot.CanFuse)
    {
        return new FusionResult(false, null, "该机器人不可用于融合！");
    }

    // 创建融合后的单位
    UnitData fusedUnit = new UnitData();
    
    // 设置基本信息
    fusedUnit.Id = UnityEngine.Random.Range(10000, 99999);
    fusedUnit.Name = $"{kuku.Name}-{robot.Name} Fusion";
    fusedUnit.Description = $"由{kuku.Name}和{robot.Name}融合而成的强大单位";
    fusedUnit.Type = UnitData.UnitType.KukuHybrid;
    
    // 合并属性（kuku属性和机器人属性的加权合并）
    fusedUnit.AttackPower = (kuku.AttackPower * 0.6f + robot.AttackPower * 0.4f) * 1.3f; // 30%融合加成
    fusedUnit.DefensePower = (kuku.DefensePower * 0.5f + robot.DefensePower * 0.5f) * 1.3f;
    fusedUnit.Speed = (kuku.Speed * 0.4f + robot.Speed * 0.6f) * 1.2f; // 机器人对速度贡献更大
    fusedUnit.Health = (kuku.Health * 0.5f + robot.Health * 0.5f) * 1.4f; // 40%融合加成
    fusedUnit.Range = Mathf.Max(kuku.SkillRange, robot.Range) * 1.1f; // 取较大值并略微提升
    
    // 保留kuku的特殊能力
    fusedUnit.AttackPower += kuku.DivinePower * 0.5f;
    fusedUnit.DefensePower += kuku.ProtectionPower * 0.5f;
    
    // 设置融合后的特殊属性
    fusedUnit.CanFuse = false; // 融合后的单位不能再融合
    fusedUnit.IsFinalForm = true; // 达到最终形态
    fusedUnit.MaxEquipmentSlots = FusionConfig.KUKU_ROBOT_FUSION_EQUIPMENT_SLOTS; // 6个装备槽位
    fusedUnit.Level = Mathf.Max(kuku.Level, robot.Level); // 取较高等级
    fusedUnit.Experience = (kuku.Experience + robot.Experience) / 2; // 平均经验
    
    // 消耗资源
    if (GameManager.Instance?.PlayerData != null)
    {
        GameManager.Instance.PlayerData.AddSouls(-50);
        GameManager.Instance.PlayerData.AddGems(-10);
    }

    string message = $"融合成功！{kuku.Name}和{robot.Name}融合成为强大的{fusedUnit.Name}！拥有{fusedUnit.MaxEquipmentSlots}个装备槽位！";

    return new FusionResult(true, fusedUnit, message, fusedUnit.MaxEquipmentSlots);
}
```

#### 3.4.3 机器人与机器人融合方法
```csharp
/// <summary>
/// 机器人与机器人融合
/// </summary>
public static FusionResult FuseUnits(UnitData unit1, UnitData unit2)
{
    // 检查融合条件
    if (unit1 == null || unit2 == null)
    {
        return new FusionResult(false, null, "融合对象不能为空！");
    }

    // 检查两个单位是否都可以融合
    if (!unit1.CanFuse || !unit2.CanFuse)
    {
        return new FusionResult(false, null, "其中一个单位不可融合！");
    }

    // 检查等级要求
    if (unit1.Level < 8 || unit2.Level < 8)
    {
        return new FusionResult(false, null, "两个机器人都需要达到8级才能融合！");
    }

    // 检查玩家是否有足够资源
    if (GameManager.Instance?.PlayerData.Coins < 500 || GameManager.Instance?.PlayerData.Gems < 20)
    {
        return new FusionResult(false, null, "资源不足，需要500金币和20神石进行融合！");
    }

    // 创建融合后的单位
    UnitData fusedUnit = new UnitData();
    
    // 设置基本信息
    fusedUnit.Id = UnityEngine.Random.Range(10000, 99999);
    fusedUnit.Name = $"{unit1.Name}-{unit2.Name} Synthesis";
    fusedUnit.Description = $"由{unit1.Name}和{unit2.Name}合成的高级单位";
    fusedUnit.Type = UnitData.UnitType.Hybrid;
    
    // 合并属性
    fusedUnit.AttackPower = (unit1.AttackPower + unit2.AttackPower) * 1.25f; // 25%合成加成
    fusedUnit.DefensePower = (unit1.DefensePower + unit2.DefensePower) * 1.25f;
    fusedUnit.Speed = (unit1.Speed + unit2.Speed) / 2 * 1.1f; // 10%速度加成
    fusedUnit.Health = (unit1.Health + unit2.Health) * 1.3f; // 30%血量加成
    fusedUnit.Range = Mathf.Max(unit1.Range, unit2.Range) * 1.15f; // 15%射程加成
    
    // 保留较高的研发等级
    fusedUnit.RequiredResearchLevel = Mathf.Max(unit1.RequiredResearchLevel, unit2.RequiredResearchLevel);
    
    // 设置融合后的特殊属性
    fusedUnit.CanFuse = true; // 仍可进一步融合
    fusedUnit.IsFinalForm = false; // 不是最终形态
    fusedUnit.MaxEquipmentSlots = FusionConfig.ROBOT_ROBOT_FUSION_EQUIPMENT_SLOTS; // 4个装备槽位
    fusedUnit.Level = Mathf.Max(unit1.Level, unit2.Level) + 1; // 等级提升
    fusedUnit.Experience = (unit1.Experience + unit2.Experience) / 2;
    
    // 消耗资源
    if (GameManager.Instance?.PlayerData != null)
    {
        GameManager.Instance.PlayerData.AddCoins(-500);
        GameManager.Instance.PlayerData.AddGems(-20);
    }

    string message = $"合成成功！{unit1.Name}和{unit2.Name}合成为{fusedUnit.Name}！拥有{fusedUnit.MaxEquipmentSlots}个装备槽位！";

    return new FusionResult(true, fusedUnit, message, fusedUnit.MaxEquipmentSlots);
}
```

#### 3.4.4 KuKu与KuKu融合方法
```csharp
/// <summary>
/// kuku与kuku融合
/// </summary>
public static FusionResult FuseKukus(MythicalKukuData kuku1, MythicalKukuData kuku2)
{
    // 检查融合条件
    if (kuku1 == null || kuku2 == null)
    {
        return new FusionResult(false, null, "融合对象不能为空！");
    }

    // 检查两个kuku是否都可以融合
    if (kuku1.EvolutionLevel < 3 || kuku2.EvolutionLevel < 3)
    {
        return new FusionResult(false, null, "两个kuku都需要进化到第3级才能融合！");
    }

    // 检查玩家是否有足够资源
    if (GameManager.Instance?.PlayerData.Souls < 30)
    {
        return new FusionResult(false, null, "灵魂不足，需要30点灵魂进行融合！");
    }

    // 创建融合后的kuku
    MythicalKukuData fusedKuku = new MythicalKukuData();
    
    // 设置基本信息
    fusedKuku.Id = UnityEngine.Random.Range(1000, 9999);
    fusedKuku.Name = $"{kuku1.Name}+{kuku2.Name}";
    fusedKuku.Description = $"由{kuku1.Name}和{kuku2.Name}融合而成的新kuku";
    fusedKuku.Element = DetermineCombinedElement(kuku1.Element, kuku2.Element);
    fusedKuku.MythologicalBackground = $"{kuku1.MythologicalBackground}与{kuku2.MythologicalBackground}的结合";
    
    // 合并属性
    fusedKuku.AttackPower = (kuku1.AttackPower + kuku2.AttackPower) * 1.2f; // 20%融合加成
    fusedKuku.DefensePower = (kuku1.DefensePower + kuku2.DefensePower) * 1.2f;
    fusedKuku.Speed = (kuku1.Speed + kuku2.Speed) / 2 * 1.15f; // 15%速度加成
    fusedKuku.Health = (kuku1.Health + kuku2.Health) * 1.25f; // 25%血量加成
    
    // 提升稀有度（如果两个都是高级稀有度）
    if ((int)kuku1.Rarity >= 3 && (int)kuku2.Rarity >= 3) // DivineBeast及以上
    {
        fusedKuku.Rarity = (MythicalKukuData.MythicalRarity)Mathf.Max((int)kuku1.Rarity, (int)kuku2.Rarity);
        if ((int)fusedKuku.Rarity < 4) // 如果还不是最高级，则提升一级
        {
            fusedKuku.Rarity = (MythicalKukuData.MythicalRarity)((int)fusedKuku.Rarity + 1);
        }
    }
    else
    {
        fusedKuku.Rarity = (MythicalKukuData.MythicalRarity)Mathf.Max((int)kuku1.Rarity, (int)kuku2.Rarity);
    }
    
    // 神话属性融合
    fusedKuku.DivinePower = (kuku1.DivinePower + kuku2.DivinePower) * 1.1f;
    fusedKuku.ProtectionPower = (kuku1.ProtectionPower + kuku2.ProtectionPower) * 1.1f;
    fusedKuku.PurificationPower = (kuku1.PurificationPower + kuku2.PurificationPower) * 1.1f;
    
    // 设置融合后的特殊属性
    fusedKuku.EvolutionLevel = Mathf.Max(kuku1.EvolutionLevel, kuku2.EvolutionLevel) + 1; // 进化等级提升
    fusedKuku.EvolutionProgress = (kuku1.EvolutionProgress + kuku2.EvolutionProgress) / 2;
    fusedKuku.EvolutionStonesRequired = Mathf.Max(kuku1.EvolutionStonesRequired, kuku2.EvolutionStonesRequired) + 15;
    fusedKuku.CanFuseWithRobots = fusedKuku.EvolutionLevel >= 5; // 根据进化等级确定是否可融合
    fusedKuku.FusionCompatibility = (kuku1.FusionCompatibility + kuku2.FusionCompatibility) / 2 * 1.1f; // 兼容性提升
    
    // 消耗资源
    if (GameManager.Instance?.PlayerData != null)
    {
        GameManager.Instance.PlayerData.AddSouls(-30);
    }

    string message = $"融合成功！{kuku1.Name}和{kuku2.Name}融合成为{fusedKuku.Name}！稀有度提升至{fusedKuku.Rarity}！";

    return new FusionResult(true, fusedKuku, message, 0); // kuku融合不产生装备槽位
}
```

#### 3.4.5 辅助方法
```csharp
/// <summary>
/// 确定融合后的元素属性
/// </summary>
private static string DetermineCombinedElement(string element1, string element2)
{
    // 简单的元素融合规则
    if (element1 == element2) return element1; // 相同元素保持不变
    
    // 不同元素的融合规则
    string[] elements = { "Fire", "Water", "Wood", "Metal", "Earth" };
    
    // 如果两个元素相邻，则可能产生新元素
    for (int i = 0; i < elements.Length; i++)
    {
        if ((elements[i] == element1 && elements[(i + 1) % elements.Length] == element2) ||
            (elements[i] == element2 && elements[(i + 1) % elements.Length] == element1))
        {
            // 例如：火+土=熔岩，水+气=雾等
            if ((element1 == "Fire" && element2 == "Earth") || (element1 == "Earth" && element2 == "Fire"))
                return "Lava";
            else if ((element1 == "Water" && element2 == "Air") || (element1 == "Air" && element2 == "Water"))
                return "Vapor";
            else if ((element1 == "Fire" && element2 == "Metal") || (element1 == "Metal" && element2 == "Fire"))
                return "Plasma";
        }
    }
    
    // 默认返回第一个元素
    return element1;
}

/// <summary>
/// 检查是否可以融合
/// </summary>
public static bool CanFuse(object obj1, object obj2)
{
    if (obj1 == null || obj2 == null) return false;

    // 根据对象类型检查融合条件
    if (obj1 is MythicalKukuData && obj2 is UnitData)
    {
        return CanKukuFuseWithRobot((MythicalKukuData)obj1, (UnitData)obj2);
    }
    else if (obj1 is UnitData && obj2 is MythicalKukuData)
    {
        return CanKukuFuseWithRobot((MythicalKukuData)obj2, (UnitData)obj1);
    }
    else if (obj1 is UnitData && obj2 is UnitData)
    {
        return CanUnitFuseWithUnit((UnitData)obj1, (UnitData)obj2);
    }
    else if (obj1 is MythicalKukuData && obj2 is MythicalKukuData)
    {
        return CanKukuFuseWithKuku((MythicalKukuData)obj1, (MythicalKukuData)obj2);
    }
    
    return false;
}

/// <summary>
/// 检查kuku是否可以与机器人融合
/// </summary>
public static bool CanKukuFuseWithRobot(MythicalKukuData kuku, UnitData robot)
{
    if (kuku == null || robot == null) return false;
    
    // 检查kuku进化等级
    if (kuku.EvolutionLevel < 5) return false;
    
    // 检查机器人等级
    if (robot.Level < 10) return false;
    
    // 检查融合兼容性
    if (kuku.FusionCompatibility < 0.5f) return false;
    
    // 检查机器人是否可融合
    if (!robot.CanFuse) return false;
    
    // 检查玩家资源
    if (GameManager.Instance?.PlayerData.Souls < 50) return false;
    
    return true;
}

/// <summary>
/// 检查机器人是否可以融合
/// </summary>
public static bool CanUnitFuseWithUnit(UnitData unit1, UnitData unit2)
{
    if (unit1 == null || unit2 == null) return false;
    
    // 检查是否都可融合
    if (!unit1.CanFuse || !unit2.CanFuse) return false;
    
    // 检查等级要求
    if (unit1.Level < 8 || unit2.Level < 8) return false;
    
    // 检查玩家资源
    if (GameManager.Instance?.PlayerData.Coins < 500 || GameManager.Instance?.PlayerData.Gems < 20) return false;
    
    return true;
}

/// <summary>
/// 检查kuku之间是否可以融合
/// </summary>
public static bool CanKukuFuseWithKuku(MythicalKukuData kuku1, MythicalKukuData kuku2)
{
    if (kuku1 == null || kuku2 == null) return false;
    
    // 检查进化等级
    if (kuku1.EvolutionLevel < 3 || kuku2.EvolutionLevel < 3) return false;
    
    // 检查玩家资源
    if (GameManager.Instance?.PlayerData.Souls < 30) return false;
    
    return true;
}

/// <summary>
/// 获取融合后可装备的槽位数
/// </summary>
public static int GetFusionEquipmentSlots(FusionRecipe recipe)
{
    return recipe.maxEquipmentSlots;
}

/// <summary>
/// 获取可用融合配方
/// </summary>
public static List<FusionRecipe> GetAvailableRecipes()
{
    List<FusionRecipe> recipes = new List<FusionRecipe>();
    
    // kuku+机器人融合配方
    recipes.Add(new FusionRecipe(
        "kuku机器人融合",
        50, // 需要50灵魂
        "将进化完全的kuku与高级机器人融合，创造终极单位",
        FusionRecipe.FusionType.KukuRobot,
        FusionConfig.KUKU_ROBOT_FUSION_EQUIPMENT_SLOTS
    ));
    
    // 机器人+机器人融合配方
    recipes.Add(new FusionRecipe(
        "机器人合成",
        20, // 需要20神石
        "将两个高级机器人合成，提升性能",
        FusionRecipe.FusionType.RobotRobot,
        FusionConfig.ROBOT_ROBOT_FUSION_EQUIPMENT_SLOTS
    ));
    
    // kuku+kuku融合配方
    recipes.Add(new FusionRecipe(
        "kuku融合",
        30, // 需要30灵魂
        "将两个进化的kuku融合，创造更强大的kuku",
        FusionRecipe.FusionType.KukuKuku,
        FusionConfig.KUKU_KUKU_FUSION_EQUIPMENT_SLOTS
    ));
    
    return recipes;
}
```

## 4. 系统交互

### 4.1 数据流
```
PlayerData → FusionSystem → Fused UnitData/MythicalKukuData
UI → FusionSystem → Fusion Result
EquipmentSystem → FusionSystem → Equipment Slots Info
```

### 4.2 事件流
- 玩家发起融合请求 → FusionSystem 验证条件 → 执行融合 → 返回结果 → UI 更新显示
- 融合成功 → PlayerData 更新单位列表 → EquipmentSystem 启用装备功能

### 4.3 依赖关系
- FusionSystem 依赖 PlayerData 验证资源
- FusionSystem 依赖 MythicalKukuData 和 UnitData 获取对象属性
- EquipmentSystem 依赖 FusionSystem 获取装备槽位信息