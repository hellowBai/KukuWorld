# 宠物收集塔防游戏《Pet Collector》核心系统设计文档

## 1. 系统概述

本文档详细描述了《Pet Collector》游戏的核心系统设计，特别针对"前5分钟捕捉→后续防守"的独特玩法进行设计。其中收集系统为游戏外的图鉴系统，捕捉系统、战斗系统等为游戏内核心玩法系统。

## 2. 神宠数据系统

### 2.1 PetData (基础宠物数据结构)

#### 2.1.1 属性定义
```csharp
// 基础信息
public int Id { get; set; }                           // 宠物唯一标识
public string Name { get; set; }                      // 宠物名称
public string Description { get; set; }               // 宠物描述

// 稀有度
public virtual RarityType Rarity { get; set; }        // 稀有度枚举
public enum RarityType { Common, Rare, Epic, Legendary, Mythic }

// 战斗属性
public float AttackPower { get; set; }                // 攻击力
public float DefensePower { get; set; }               // 防御力
public float Speed { get; set; }                      // 速度
public float Health { get; set; }                     // 生命值

// 视觉相关
public string SpriteName { get; set; }                // 精灵名称
public Color Tint { get; set; }                       // 着色

// 状态
public bool IsCollected { get; set; }                 // 是否已收集（游戏内）
public int Level { get; set; }                        // 等级
public float Experience { get; set; }                 // 经验值

// 技能相关
public string SkillName { get; set; }                 // 技能名称
public float SkillDamage { get; set; }                // 技能伤害
public float SkillCooldown { get; set; }              // 技能冷却

// 捕捉相关
public float CaptureDifficulty { get; set; }          // 捕捉难度系数
public bool CanAbsorbSoul { get; set; }              // 是否能吸收灵魂
public float SoulAbsorptionRate { get; set; }         // 灵魂吸收率
```

#### 2.1.2 方法定义
```csharp
// 获取稀有度颜色
public virtual Color GetRarityColor()

// 升级宠物
public void LevelUp()

// 添加经验值
public bool AddExperience(float exp)

// 吸收灵魂进行进化
public bool AbsorbSoul(float soulPower)

// 获取捕捉成功率
public float GetCaptureSuccessRate(float playerPower)
```

### 2.2 MythicalPetData (神话宠物数据结构)

#### 2.2.1 继承关系
- 继承自 PetData 类

#### 2.2.2 神话专属属性
```csharp
// 神话背景
public string MythologicalBackground { get; set; }    // 神话背景
public string Element { get; set; }                   // 元素属性 (金木水火土)

// 神话技能系统
public enum MythicalSkillType { 
    GuardianShield, HealingAura, ElementalBlast, 
    SummonAssist, Purification, DivineProtection, 
    LifeLink, BarrierCreation 
}
public MythicalSkillType SkillType { get; set; }      // 技能类型
public string SkillDescription { get; set; }          // 技能描述
public float SkillRange { get; set; }                 // 技能范围
public float SkillPower { get; set; }                 // 技能威力

// 神话属性加成
public float DivinePower { get; set; }                // 神力
public float ProtectionPower { get; set; }            // 守护力
public float PurificationPower { get; set; }          // 净化力

// 神话稀有度
public new MythicalRarity Rarity { get; set; }        // 神话稀有度
public enum MythicalRarity { 
    Celestial, Immortal, DivineBeast, Sacred, Primordial 
}

// 进化相关
public int EvolutionLevel { get; set; }               // 进化等级
public float EvolutionProgress { get; set; }          // 进化进度
public int EvolutionStonesRequired { get; set; }      // 进化所需神石

// 融合相关
public bool CanFuseWithRobots { get; set; }           // 是否可与机器人融合
public float FusionCompatibility { get; set; }        // 融合兼容性
```

#### 2.2.3 神话专属方法
```csharp
// 获取神话稀有度颜色
public Color GetMythicalRarityColor()

// 重写升级方法，增加神话属性
public new void LevelUp()

// 重写添加经验值方法
public new bool AddExperience(float exp)

// 重写吸收灵魂方法
public new bool AbsorbSoul(float soulPower)

// 检查是否可以与机器人融合
public bool CanFuseWithRobot(UnitData robot)

// 执行与机器人的融合
public object FuseWithRobot(UnitData robot)
```

## 3. 游戏外收集系统

### 3.1 PetCollectionManager (收集管理器)

#### 3.1.1 系统职责
- 管理宠物图鉴数据库（游戏外）
- 处理图鉴收集进度
- 管理图鉴显示界面
- 处理页面切换

#### 3.1.2 属性定义
```csharp
public static PetCollectionManager Instance { get; private set; } // 单例实例

// 数据存储
private Dictionary<int, PetData> allPetDatabase;                   // 宠物数据库
private int currentPageIndex;                                      // 当前页面索引
private const int PETS_PER_PAGE = 12;                             // 每页宠物数量

// 事件系统
public event Action<PetData> OnPetUnlocked;                        // 宠物解锁事件
public event Action<int, float> OnPageCompleted;                   // 页面完成事件
public event Action OnCollectionUpdated;                           // 收集更新事件
```

#### 3.1.3 核心方法
```csharp
// 初始化宠物数据库
private void InitializePetDatabase()

// 生成神话宠物名字
private string GenerateMythicalPetName(int id)

// 获取指定ID的宠物数据
public PetData GetPetTemplate(int petId)
public MythicalPetData GetMythicalPetTemplate(int petId)

// 获取玩家拥有的宠物数据
public PetData GetPlayerPet(int petId)
public MythicalPetData GetPlayerMythicalPet(int petId)

// 解锁宠物（由游戏内系统调用）
public void UnlockPet(int petId)

// 根据概率获取随机宠物
public PetData GetRandomPetByProbability()

// 获取当前页面的宠物列表
public List<PetData> GetCurrentPagePets()
public List<PetData> GetPagePets(int pageIndex)

// 获取总页数
public int GetTotalPages()

// 切换页面
public void SwitchToPage(int pageIndex)
public void NextPage()
public void PreviousPage()

// 获取收集进度
public float GetCollectionProgress()
public float GetRarityCollectionProgress(PetData.RarityType rarity)
```

### 3.2 EvolutionSystem (进化系统)

#### 3.2.1 系统职责
- 处理宠物进化逻辑
- 管理进化成功率
- 计算进化后属性
- 支持灵魂吸收进化机制

#### 3.2.2 数据结构
```csharp
// 进化结果结构
public struct EvolutionResult
{
    public bool success;
    public MythicalPetData evolvedPet;
    public string message;
    public bool isFinalEvolution;     // 是否达到最终进化等级（可融合）

    public EvolutionResult(bool isSuccess, MythicalPetData pet, string msg, bool isFinal = false)
    {
        success = isSuccess;
        evolvedPet = pet;
        message = msg;
        isFinalEvolution = isFinal;
    }
}

// 灵魂类型枚举
public enum SoulType { 
    Common, Rare, Epic, Legendary, Mythic, Divine 
}
```

#### 3.2.3 核心方法
```csharp
// 尝试进化宠物
public static EvolutionResult EvolvePet(MythicalPetData pet)

// 通过吸收灵魂进化宠物
public static EvolutionResult EvolvePetWithSoul(MythicalPetData pet, float soulPower, SoulType soulType)

// 获取进化成功率
public static float GetEvolutionSuccessRate(MythicalPetData pet)

// 获取进化预览
public static MythicalPetData GetEvolutionPreview(MythicalPetData pet)

// 计算灵魂吸收效果
public static float CalculateSoulEffectiveness(MythicalPetData pet, float soulPower, SoulType soulType)

// 检查宠物是否已达到最终进化等级
public static bool IsMaxEvolutionLevel(MythicalPetData pet)
```

## 4. 捕捉系统

### 4.1 CaptureSystem (捕捉系统)

#### 4.1.1 系统职责
- 管理野外神宠生成
- 处理捕捉逻辑
- 管理捕捉成功率
- 控制捕捉阶段的宠物刷新

#### 4.1.2 数据结构
```csharp
// 野外神宠结构
public struct WildPet
{
    public MythicalPetData petData;
    public Vector3 position;
    public float remainingHP;
    public bool isCapturable;
    public float timeUntilDespawn;                        // 消失倒计时
    public bool isSoulAbsorbing;                         // 是否正在吸收灵魂
    public float soulAccumulated;                        // 已积累的灵魂值
}

// 捕捉结果结构
public struct CaptureResult
{
    public bool success;
    public MythicalPetData capturedPet;
    public string message;
    public List<ItemDrop> drops;                         // 捕捉成功后的掉落物
}

// 掉落物结构
public struct ItemDrop
{
    public ItemType type;
    public float value;
    public int quantity;
    
    public enum ItemType { Soul, Coin, PetEgg, Resource }
}
```

#### 4.1.3 核心方法
```csharp
// 生成野外神宠
public static void GenerateWildPet(Vector3 position, MythicalPetData.MythicalRarity rarity)

// 攻击野生神宠
public static bool AttackWildPet(int petId, float damage, out string message)

// 尝试捕捉野生神宠
public static CaptureResult AttemptCapture(int petId, MythicalPetData capturerPet)

// 获取野外神宠列表
public static List<WildPet> GetWildPets()

// 获取捕捉信息
public static (bool canCapture, float successRate, float hpRatio, string status) GetCaptureInfo(int petId)

// 检查位置是否有野生神宠
public static bool HasWildPetAtPosition(Vector3 position, float radius)

// 更新野生神宠（处理消失、灵魂积累等）
public static void UpdateWildPets(float deltaTime)

// 野怪死亡处理（掉落物生成）
public static ItemDrop[] ProcessWildPetDeath(int petId)
```

### 4.2 ExplorationSystem (探索系统)

#### 4.2.1 系统职责
- 管理地图探索区域
- 控制神宠随机生成
- 处理探索事件
- 管理5分钟捕捉期内的刷新机制

#### 4.2.2 属性定义
```csharp
// 配置参数
public float explorationAreaSize = 20f;                    // 探索区域大小
public int maxWildPets = 10;                              // 最大野外神宠数量
public float wildPetRespawnTime = 30f;                    // 重生时间
public float explorationCheckInterval = 5f;               // 检查间隔
public float capturePhaseDuration = 300f;                 // 捕捉阶段持续时间(5分钟)

// 边界
private Bounds explorationBounds;                          // 探索边界

// 捕捉阶段控制
private float timeInCapturePhase = 0f;                    // 捕捉阶段已进行时间
private bool capturePhaseActive = true;                   // 捕捉阶段是否激活

// 事件
public event Action<Vector3> OnWildPetSpotted;            // 发现神宠事件
public event Action<string> OnExplorationEvent;           // 探索事件
public event Action OnCapturePhaseEnded;                  // 捕捉阶段结束事件
public event Action OnDefensePhaseStarted;                // 防守阶段开始事件
```

#### 4.2.3 核心方法
```csharp
// 初始化系统
private void InitializeExplorationSystem()

// 检查并重生野生神宠
private void CheckAndRespawnWildPets()

// 获取随机探索位置
private Vector3 GetRandomExplorationPosition()

// 根据玩家等级获取随机稀有度
private MythicalPetData.MythicalRarity GetRandomRarityForPlayerLevel()

// 玩家探索指定区域
public void ExploreArea(Vector3 position)

// 获取探索信息
public (Bounds bounds, int currentPets, int maxPets) GetExplorationInfo()

// 更新探索系统（时间控制）
public void UpdateExplorationSystem(float deltaTime)

// 开始捕捉阶段
public void StartCapturePhase()

// 结束捕捉阶段，开始防守阶段
public void StartDefensePhase()

// 检查是否仍在捕捉阶段
public bool IsInCapturePhase()
```

### 4.3 CaptureUI (捕捉界面)

#### 4.3.1 系统职责
- 显示野外神宠信息
- 处理捕捉操作界面
- 管理捕捉状态显示
- 显示捕捉阶段倒计时

#### 4.3.2 属性定义
```csharp
// 界面组件
public GameObject capturePanel;                            // 捕捉面板
public Transform wildPetContainer;                        // 野外神宠容器
public GameObject wildPetCardPrefab;                      // 神宠卡片预制体

// 信息显示
public TextMeshProUGUI selectedPetNameText;               // 宠物名称
public TextMeshProUGUI selectedPetRarityText;             // 宠物稀有度
public TextMeshProUGUI selectedPetHpText;                 // 宠物生命值
public Slider selectedPetHpSlider;                        // 生命值滑动条
public TextMeshProUGUI captureStatusText;                 // 捕捉状态
public TextMeshProUGUI captureSuccessRateText;            // 捕捉成功率
public TextMeshProUGUI capturePhaseTimerText;             // 捕捉阶段倒计时

// 按钮
public Button attackButton;                                // 攻击按钮
public Button captureButton;                              // 捕捉按钮
public Button soulAbsorbButton;                           // 灵魂吸收按钮
```

#### 4.3.3 核心方法
```csharp
// 初始化界面
private void InitializeUI()

// 打开/关闭捕捉面板
public void OpenCapturePanel()
public void CloseCapturePanel()

// 刷新野外神宠列表
public void RefreshWildPetList()

// 野外神宠被选中
private void OnWildPetSelected(CaptureSystem.WildPet wildPet)

// 更新选中宠物信息
private void UpdateSelectedPetInfo()

// 攻击选中的野生神宠
private void AttackSelectedWildPet(bool usePet)

// 尝试捕捉选中的神宠
private void AttemptCaptureSelectedPet(bool useSpecialMethod)

// 灵魂吸收操作
private void AbsorbSoulFromSelectedPet()

// 更新捕捉阶段倒计时显示
public void UpdateCaptureTimerDisplay(float timeRemaining)

// 更新按钮可用性
private void UpdateButtonAvailability()
```

## 5. 战斗系统

### 5.1 BattleSystem (战斗系统)

#### 5.1.1 系统职责
- 管理塔防战斗逻辑
- 控制敌人生成
- 处理战斗状态
- 管理防守阶段的敌人波次

#### 5.1.2 数据结构
```csharp
// 战斗状态
public enum BattleState { 
    Setup,                    // 设置阶段
    CapturePhase,             // 捕捉阶段（前5分钟）
    DefensePhaseSetup,        // 防守阶段设置
    WaveStart,                // 波次开始
    Fighting,                 // 战斗中
    Victory,                  // 胜利
    Defeat                    // 失败
}

// 敌人类型
public enum EnemyType { 
    WildPet,                  // 野生宠物转化的敌人
    Demon,                    // 邪魔
    EliteDemon,               // 精英邪魔
    Boss                      // BOSS
}
```

#### 5.1.3 属性定义
```csharp
// 配置参数
public float BaseEnemySpawnInterval = 2.0f;              // 基础生成间隔
public int MaxEnemiesOnField = 10;                       // 最大敌人数量
public Transform[] SpawnPoints;                          // 生成点
public Transform[] TemplePoints;                         // 目标点

// 战斗数据
private BattleState currentState = BattleState.CapturePhase; // 当前状态
private int currentWave;                                 // 当前波次
private int enemiesRemaining;                            // 剩余敌人
private int playerLives;                                 // 玩家生命（守护点血量）
private float timeUntilNextWave;                         // 下一波倒计时
private List<GameObject> activeEnemies;                  // 活跃敌人
private List<GameObject> activePets;                     // 活跃宠物（玩家防守单位）
private List<GameObject> activeUnits;                    // 活跃单位（建筑生产的机器人/坦克）

// 事件
public event Action<int, int> OnWaveChanged;             // 波次变化
public event Action<int> OnPlayerLifeChanged;            // 生命变化
public event Action OnBattleVictory;                     // 战斗胜利
public event Action OnBattleDefeat;                      // 战斗失败
public event Action OnCapturePhaseEnded;                 // 捕捉阶段结束
public event Action OnDefensePhaseStarted;               // 防守阶段开始
```

#### 5.1.4 核心方法
```csharp
// 开始战斗
public void StartBattle()

// 初始化战斗
private void InitializeBattle()

// 生成玩家宠物
private void SpawnPlayerPets()

// 开始下一波
public void StartNextWave()

// 更新战斗逻辑
private void UpdateBattleLogic()

// 生成敌人
private void SpawnEnemy(EnemyType type = EnemyType.WildPet)

// 敌人被击败
public void EnemyDefeated(GameObject enemy)

// 敌人到达终点
public void EnemyReachedEnd(GameObject enemy)

// 切换到防守阶段
public void TransitionToDefensePhase()

// 检查是否在捕捉阶段
public bool IsInCapturePhase()

// 检查是否在防守阶段
public bool IsInDefensePhase()

// 获取战斗状态信息
public (BattleState state, int wave, int lives, int enemies) GetBattleStatus()
```

### 5.2 NuwaDefenseSystem (女娲守护系统)

#### 5.2.1 系统职责
- 管理守护女娲神殿的战斗
- 控制邪魔攻击逻辑
- 处理神殿保护
- 管理防守阶段的难度递增

#### 5.2.2 属性定义
```csharp
// 神殿相关
public GameObject nuwaTemple;                            // 女娲神殿
public int nuwaTempleHealth = 1000;                      // 神殿生命值
public int maxTempleHealth = 1000;                       // 神殿最大生命值

// 配置参数
public Transform[] evilSpawnPoints;                      // 邪魔出生点
public Transform[] nuwaTemplePoints;                     // 神殿目标点
public float difficultyIncreaseRate = 0.1f;              // 难度递增率

// 战斗数据
private int waveNumber;                                  // 波次数
private int evilCount;                                   // 邪魂数量
private bool isDefending;                                // 是否在防守
private float cumulativeDifficulty;                      // 累积难度

// 事件
public event Action<int> OnWaveStarted;                  // 波次开始
public event Action<int, int> OnEvilSpawned;             // 邪魔生成
public event Action<int> OnTempleHealthChanged;          // 神殿生命变化
public event Action OnDefenseSuccess;                    // 防守成功
public event Action OnDefenseFailed;                     // 防守失败
```

#### 5.2.3 核心方法
```csharp
// 初始化守护系统
private void InitializeDefenseSystem()

// 开始守护
public void StartDefense()

// 开始指定波次
private void StartWave(int waveNum)

// 邪魔攻击神殿
public void EvilAttackedTemple(float damage)

// 邪魔被击败
public void EvilDefeated()

// 完成当前波次
public void CompleteWave()

// 防守成功/失败
private void SuccessDefense()
private void FailDefense()

// 获取守护状态
public (bool defending, int wave, int health, int maxHealth) GetDefenseStatus()

// 计算当前难度系数
public float GetCurrentDifficultyMultiplier()

// 生成特定类型的邪魔
public GameObject SpawnSpecificEvil(EnemyType type, int waveNum)
```

## 6. 建筑系统

### 6.1 BuildingData (建筑数据)

#### 6.1.1 属性定义
```csharp
// 基础信息
public int Id { get; set; }                              // 建筑ID
public string Name { get; set; }                         // 建筑名称
public string Description { get; set; }                  // 建筑描述

// 建筑类型
public BuildingType Type { get; set; }                   // 建筑类型
public enum BuildingType { 
    Tower,                                              // 防御塔
    Research,                                           // 研究所
    Production,                                         // 生产工厂
    Special,                                            // 特殊建筑
    SoulCollector                                        // 灵魂收集器（捕捉阶段特有）
}

// 等级和需求
public int Level { get; set; } = 1;                     // 等级
public int RequiredResearchLevel { get; set; } = 0;     // 需要研究等级
public int RequiredCoins { get; set; } = 100;           // 需要金币
public int RequiredGems { get; set; } = 0;              // 需要神石

// 属性（根据类型不同）
public float AttackPower { get; set; } = 0f;            // 攻击力（塔类）
public float Range { get; set; } = 0f;                  // 射程（塔类）
public float Health { get; set; } = 100f;               // 生命值
public float BuildTime { get; set; } = 10f;             // 建造时间

// 研究属性
public float ResearchSpeed { get; set; } = 0f;          // 研究速度（研究类）
public int MaxResearchLevel { get; set; } = 10;         // 最大研究等级

// 生产属性
public float ProductionSpeed { get; set; } = 0f;        // 生产速度（生产类）
public string ProducedItem { get; set; } = "";          // 生产物品
public UnitType ProducesUnitType { get; set; } = UnitType.Robot; // 生产单位类型

// 特殊属性
public bool IsUpgradeable { get; set; } = true;         // 是否可升级
public int UpgradeCostMultiplier { get; set; } = 2;     // 升级花费倍数

// 捕捉阶段特有属性
public float SoulCollectionRate { get; set; } = 0f;     // 灵魂收集速率（灵魂收集器）
public bool IsActiveDuringCapturePhase { get; set; } = true; // 捕捉阶段是否激活

// 视觉相关
public string SpriteName { get; set; }                   // 精灵名称
public Color Tint { get; set; } = Color.white;          // 着色
```

#### 6.1.2 核心方法
```csharp
// 升级建筑
public void Upgrade()

// 获取建造花费
public (int coins, int gems) GetBuildCost()

// 获取升级花费
public (int coins, int gems) GetUpgradeCost()

// 检查是否可以建造（基于当前游戏阶段）
public bool CanBuildInCurrentPhase(BattleSystem.BattleState currentPhase)

// 激活建筑（开始工作）
public void Activate()

// 停止建筑
public void Deactivate()
```

### 6.2 BuildingManager (建筑管理器)

#### 6.2.1 系统职责
- 管理所有建筑实例
- 处理建筑建造和升级
- 控制建筑在不同阶段的激活状态

#### 6.2.2 核心方法
```csharp
// 建造建筑
public bool BuildBuilding(BuildingData building, Vector3 position)

// 升级建筑
public bool UpgradeBuilding(int buildingId)

// 激活所有建筑（根据当前阶段）
public void ActivateBuildingsForPhase(BattleSystem.BattleState phase)

// 更新建筑逻辑
public void UpdateBuildings(float deltaTime)

// 获取指定类型的建筑
public List<BuildingData> GetBuildingsOfType(BuildingData.BuildingType type)

// 获取可生产指定单位的建筑
public List<BuildingData> GetProductionBuildingsForUnit(UnitData.UnitType unitType)
```

## 7. 单位系统

### 7.1 UnitData (单位数据)

#### 7.1.1 属性定义
```csharp
// 基础信息
public int Id { get; set; }                              // 单位ID
public string Name { get; set; }                         // 单位名称
public string Description { get; set; }                  // 单位描述

// 单位类型
public UnitType Type { get; set; }                       // 单位类型
public enum UnitType { Robot, Tank, Hybrid, PetHybrid }  // PetHybrid是宠物与机器人融合后的单位

// 战斗属性
public float AttackPower { get; set; }                   // 攻击力
public float DefensePower { get; set; }                  // 防御力
public float Speed { get; set; }                         // 速度
public float Health { get; set; }                        // 生命值
public float Range { get; set; }                         // 射程

// 生产相关
public int ProductionCost { get; set; } = 100;          // 生产花费
public int RequiredResearchLevel { get; set; } = 1;     // 需要研究等级
public float ProductionTime { get; set; } = 10f;        // 生产时间

// 融合相关
public bool CanFuse { get; set; } = true;               // 是否可融合
public int FusionCost { get; set; } = 200;              // 融合花费
public string FusionRecipe { get; set; } = "";          // 融合配方
public bool IsFinalForm { get; set; } = false;          // 是否为最终形态（可装备6件装备）

// 状态
public bool IsDeployed { get; set; } = false;           // 是否已部署
public int Level { get; set; } = 1;                     // 等级
public float Experience { get; set; } = 0;              // 经验值

// 装备槽位
public int MaxEquipmentSlots { get; set; } = 0;         // 最大装备槽位数
public List<WeaponData> EquippedItems { get; set; }     // 已装备物品
```

#### 7.1.2 核心方法
```csharp
// 升级单位
public void LevelUp()

// 添加经验值
public bool AddExperience(float exp)

// 获取生产花费
public int GetProductionCost()

// 设置融合配方
public void SetFusionRecipe(string recipe)

// 融合两个单位
public static UnitData FuseUnits(UnitData unit1, UnitData unit2, string fusionName)

// 宠物与机器人融合
public static UnitData FusePetWithRobot(MythicalPetData pet, UnitData robot, string fusionName)

// 检查是否可以装备物品
public bool CanEquipItem(WeaponData item)

// 装备物品
public bool EquipItem(WeaponData item)

// 卸下物品
public bool UnequipItem(WeaponData item)

// 获取总属性（包含装备加成）
public (float atk, float def, float spd, float hp, float rng) GetTotalAttributes()
```

## 8. 融合系统

### 8.1 FusionSystem (融合系统)

#### 8.1.1 系统职责
- 处理各类融合逻辑
- 管理融合配方
- 计算融合结果
- 特别处理宠物与机器人的融合

#### 8.1.2 数据结构
```csharp
// 融合结果
public struct FusionResult
{
    public bool success;
    public object fusedObject;
    public string message;
    public int equipmentSlots;        // 融合后可用的装备槽位数（通常是6个）
    
    public FusionResult(bool isSuccess, object obj, string msg, int slots = 0)
    {
        success = isSuccess;
        fusedObject = obj;
        message = msg;
        equipmentSlots = slots;
    }
}

// 融合配方
public struct FusionRecipe
{
    public string resultName;
    public int fusionCost;
    public string description;
    public FusionType type;                               // 融合类型
    public int maxEquipmentSlots;                         // 融合后装备槽数量
    
    public enum FusionType { 
        PetRobot,                                         // 宠物+机器人
        RobotRobot,                                       // 机器人+机器人
        PetPet,                                           // 宠物+宠物
        UnitUnit                                          // 单位+单位
    }
}
```

#### 8.1.3 核心方法
```csharp
// 尝试融合两个对象
public static FusionResult FuseObjects(object obj1, object obj2)

// 宠物与机器人融合
public static FusionResult FusePetWithRobot(MythicalPetData pet, UnitData robot)

// 获取可用融合配方
public static List<FusionRecipe> GetAvailableRecipes()

// 检查是否可以融合
public static bool CanFuse(object obj1, object obj2)

// 检查宠物是否达到最终进化等级（可融合）
public static bool CanPetFuseWithRobot(MythicalPetData pet)

// 检查机器人是否达到最高等级（可融合）
public static bool CanRobotFuseWithPet(UnitData robot)

// 获取融合后可装备的槽位数
public static int GetFusionEquipmentSlots(FusionRecipe recipe)
```

## 9. 装备系统

### 9.1 WeaponData (武器数据)

#### 9.1.1 属性定义
```csharp
// 基础信息
public int Id { get; set; }                              // 武器ID
public string Name { get; set; }                         // 武器名称
public string Description { get; set; }                  // 武器描述

// 武器类型
public WeaponType Type { get; set; }                     // 武器类型
public enum WeaponType { 
    Sword, Shield, Cannon, Laser, Missile, 
    Armor, Engine, Processor, Crystal, Orb 
}

// 等级
public WeaponTier Tier { get; set; }                     // 武器等级
public enum WeaponTier { Basic, Advanced, Expert, Master, Legendary }

// 战斗属性
public float AttackBonus { get; set; } = 0f;            // 攻击加成
public float DefenseBonus { get; set; } = 0f;           // 防御加成
public float SpeedBonus { get; set; } = 0f;             // 速度加成
public float HealthBonus { get; set; } = 0f;            // 生命加成
public float RangeBonus { get; set; } = 0f;             // 射程加成
public float SpecialEffect { get; set; } = 0f;          // 特殊效果

// 装备槽位
public EquipmentSlot Slot { get; set; }                  // 装备槽位
public enum EquipmentSlot { Weapon, Shield, Head, Body, Legs, Accessory }

// 合成相关
public bool IsCombinable { get; set; } = true;          // 是否可合成
public int CombineCost { get; set; } = 50;              // 合成花费
public int RequiredTierToCombine { get; set; } = 0;     // 合成所需等级
public int ComponentsNeeded { get; set; } = 2;          // 合成所需组件

// 装备相关
public int EquipCost { get; set; } = 0;                 // 装备花费
public int RequiredLevel { get; set; } = 1;             // 装备所需等级

// 状态
public bool IsEquipped { get; set; } = false;           // 是否已装备
public int Durability { get; set; } = 100;              // 耐久度
```

### 9.2 EquipmentSystem (装备系统)

#### 9.2.1 系统职责
- 管理装备合成逻辑
- 处理装备穿戴
- 计算装备属性加成
- 管理商店装备购买

#### 9.2.2 数据结构
```csharp
// 合成结果
public struct CombineResult
{
    public bool success;
    public WeaponData combinedWeapon;
    public string message;
}

// 装备结果
public struct EquipResult
{
    public bool success;
    public string message;
}

// 商店物品
public struct ShopItem
{
    public WeaponData item;
    public int price;
    public bool isAvailable;
}
```

#### 9.2.3 核心方法
```csharp
// 合成武器
public static CombineResult CombineWeapons(WeaponData component1, WeaponData component2, string customName)

// 为单位装备武器
public static EquipResult EquipWeapon(object unit, WeaponData weapon)

// 卸下装备
public static bool UnequipWeapon(object unit, WeaponData weapon)

// 获取可用装备槽位
public static List<EquipmentSlot> GetAvailableSlots(object unit)

// 获取兼容武器类型
public static List<WeaponData.WeaponType> GetCompatibleWeaponTypes(object unit)

// 检查是否可以合成
public static bool CanCombine(WeaponData weapon1, WeaponData weapon2)

// 检查单位是否可以装备
public static bool CanEquip(object unit, WeaponData weapon)

// 获取商店可用物品
public static List<ShopItem> GetShopInventory()

// 购买商店物品
public static bool PurchaseItem(WeaponData item, int price)

// 更新商店库存
public static void RefreshShopInventory()
```

## 10. 玩家数据系统

### 10.1 PlayerData (玩家数据)

#### 10.1.1 系统职责
- 管理玩家相关信息
- 包括英雄技能、资源、建筑等
- 管理捕捉阶段和防守阶段的状态

#### 10.1.2 属性定义
```csharp
// 基础信息
public string PlayerName { get; set; }                   // 玩家姓名
public int Level { get; set; } = 1;                     // 玩家等级
public float Experience { get; set; } = 0;              // 经验值

// 英雄系统
public HeroData Hero { get; set; }                       // 英雄数据
public List<HeroSkill> AvailableSkills { get; set; }     // 可用技能

// 资源
public int Coins { get; set; } = 1000;                  // 金币
public int Gems { get; set; } = 100;                    // 神石
public float Souls { get; set; } = 0f;                  // 灵魂值

// 宠物收集（游戏内实际拥有的宠物）
public Dictionary<int, PetData> CollectedPets { get; set; } // 收集的宠物
public List<int> ActivePetTeam { get; set; }            // 当前宠物队伍

// 建筑
public List<BuildingData> BuiltBuildings { get; set; }   // 已建造建筑
public List<UnitData> DeployedUnits { get; set; }       // 已部署单位

// 游戏阶段状态
public bool IsInCapturePhase { get; set; } = true;      // 是否在捕捉阶段
public float TimeInCapturePhase { get; set; } = 0f;     // 捕捉阶段时间
public int EnemiesDefeatedInDefense { get; set; } = 0;  // 防守阶段击败敌人数量
public int CurrentWaveInDefense { get; set; } = 0;      // 防守阶段当前波次

// 装备
public List<WeaponData> OwnedEquipment { get; set; }    // 拥有装备
public Dictionary<int, List<WeaponData>> UnitEquipment { get; set; } // 单位装备映射
```

#### 10.1.3 核心方法
```csharp
// 添加金币
public void AddCoins(int amount)

// 添加神石
public void AddGems(int amount)

// 添加灵魂
public void AddSouls(float amount)

// 添加经验值
public bool AddExperience(float exp)

// 添加宠物到收藏（游戏内）
public void AddPet(PetData pet)

// 通知收集系统解锁宠物（游戏外）
public void NotifyPetUnlocked(int petId)

// 移除宠物
public bool RemovePet(int petId)

// 升级玩家等级
public void LevelUp()

// 检查是否有足够资源
public bool HasResources(int coins, int gems)

// 消耗资源
public bool ConsumeResources(int coins, int gems)

// 检查是否可以进入防守阶段
public bool CanStartDefensePhase()

// 切换到防守阶段
public void EnterDefensePhase()

// 获取玩家战斗力评分
public float GetPlayerCombatRating()
```

### 10.2 HeroData (英雄数据)

#### 10.2.1 属性定义
```csharp
public string HeroName { get; set; }                     // 英雄名称
public HeroClass Class { get; set; }                     // 英雄职业
public List<HeroSkill> Skills { get; set; }              // 技能列表

public enum HeroClass { 
    Warrior,     // 战士 - 擅长近战和防御
    Mage,        // 法师 - 擅长魔法攻击和辅助
    Ranger,      // 游侠 - 擅长远程攻击和捕捉
    Guardian     // 守护者 - 擅长守护和治疗
}

public enum SkillType { 
    Active,      // 主动技能
    Passive      // 被动技能
}
```

#### 10.2.2 核心方法
```csharp
// 使用技能
public bool UseSkill(int skillId)

// 升级技能
public bool UpgradeSkill(int skillId)

// 获取技能效果
public float GetSkillEffect(int skillId)
```

## 11. 用户界面系统

### 11.1 GameManager (游戏主管理器)

#### 11.1.1 系统职责
- 管理全局游戏状态
- 协调各系统交互
- 处理游戏流程
- 控制捕捉阶段到防守阶段的转换

#### 11.1.2 数据结构
```csharp
// 游戏状态
public enum GameState { 
    MainMenu,      // 主菜单
    CapturePhase,  // 捕捉阶段
    DefensePhase,  // 防守阶段
    Shop,          // 商店
    Settings,      // 设置
    GameOver       // 游戏结束
}
```

#### 11.1.3 属性定义
```csharp
public static GameManager Instance { get; private set; } // 单例实例
public GameState CurrentState { get; private set; }      // 当前状态
public PlayerData PlayerData { get; private set; }       // 玩家数据
public BattleSystem BattleSystem { get; private set; }   // 战斗系统引用
public CaptureSystem CaptureSystem { get; private set; } // 捕捉系统引用
```

#### 11.1.4 核心方法
```csharp
// 切换游戏状态
public void ChangeState(GameState newState)

// 开始新游戏
public void StartNewGame()

// 更新游戏逻辑
public void UpdateGame(float deltaTime)

// 退出游戏
public void QuitGame()

// 检查是否需要从捕捉阶段切换到防守阶段
public void CheckPhaseTransition()

// 处理游戏结束
public void HandleGameOver(bool victory)
```

### 11.2 CaptureUI (捕捉界面)

#### 11.2.1 系统职责
- 显示捕捉阶段相关信息
- 处理捕捉操作
- 显示捕捉阶段倒计时

#### 11.2.2 核心方法
```csharp
// 更新捕捉阶段倒计时
public void UpdateCaptureTimer(float timeRemaining)

// 显示捕捉阶段结束提示
public void ShowCapturePhaseEnding()

// 切换到防守界面
public void SwitchToDefenseUI()
```

### 11.3 DefenseUI (防守界面)

#### 11.3.1 系统职责
- 显示防守阶段相关信息
- 处理建筑建造和升级
- 显示神殿生命值和波次信息

#### 11.3.2 核心方法
```csharp
// 更新神殿生命值显示
public void UpdateTempleHealth(int current, int max)

// 更新波次信息
public void UpdateWaveInfo(int currentWave, int enemiesRemaining)

// 更新资源显示
public void UpdateResourceDisplay()

// 显示建造菜单
public void ShowBuildMenu()

// 显示单位生产菜单
public void ShowProductionMenu()
```

### 11.4 ShopUI (商店界面)

#### 11.4.1 系统职责
- 显示可购买的装备
- 处理购买操作
- 管理玩家资源显示

#### 11.4.2 核心方法
```csharp
// 刷新商店库存
public void RefreshInventory()

// 处理购买操作
public void ProcessPurchase(WeaponData item)

// 更新玩家资源显示
public void UpdatePlayerResources()
```

## 12. 系统交互关系

### 12.1 数据流向
- GameManager → PlayerData (管理玩家数据)
- CaptureSystem → PlayerData (捕捉成功后添加宠物和资源)
- BattleSystem ↔ PlayerData (战斗结果影响玩家数据)
- FusionSystem → PlayerData (融合结果更新玩家单位)
- EquipmentSystem → PlayerData (装备操作更新玩家数据)
- PlayerData → PetCollectionManager (解锁宠物到图鉴)

### 12.2 事件驱动
- CaptureSystem → GameManager (捕捉阶段结束事件)
- BattleSystem → GameManager (防守阶段开始/结束事件)
- PlayerData → PetCollectionManager (解锁宠物事件)
- CaptureSystem → UI (发现宠物、捕捉成功等事件)
- BuildingManager → BattleSystem (建筑生产单位事件)

### 12.3 依赖关系
- UI系统依赖所有数据系统
- BattleSystem依赖CaptureSystem(捕捉阶段结束后接管)
- PetCollectionManager相对独立，只接收来自PlayerData的解锁通知
- FusionSystem依赖PetData和UnitData
- EquipmentSystem依赖WeaponData和UnitData
- PlayerData是核心数据枢纽，被大多数系统依赖