# KukuWorld 游戏配置和设置文档

## 1. 配置系统概述

KukuWorld 游戏配置系统采用分层架构设计，支持默认配置、用户配置和运行时配置。配置系统确保游戏在不同平台和环境下都能正常运行，并提供丰富的自定义选项。

## 2. 配置文件结构

### 2.1 配置文件类型

#### 2.1.1 默认配置 (DefaultConfig.asset)
- 游戏默认参数
- 平衡性数值
- 初始设置

#### 2.1.2 用户配置 (UserConfig.json)
- 用户个性化设置
- 控制设置
- 显示偏好

#### 2.1.3 运行时配置 (RuntimeConfig.json)
- 当前会话设置
- 动态参数调整
- 调试选项

### 2.2 配置文件路径
```
Assets/
├── Configs/
│   ├── DefaultConfig.asset
│   ├── Settings/
│   │   ├── GraphicsSettings.asset
│   │   ├── AudioSettings.asset
│   │   └── ControlsSettings.asset
│   └── Balancing/
│       ├── CaptureBalancing.asset
│       ├── BattleBalancing.asset
│       └── EvolutionBalancing.asset
```

## 3. 核心配置参数

### 3.1 游戏系统配置

#### 3.1.1 捕捉系统配置
```json
{
  "captureSystem": {
    "capturePhaseDuration": 300,
    "baseCaptureSuccessRate": 0.7,
    "captureDifficultyMultiplier": {
      "celestial": 1.0,
      "immortal": 1.2,
      "divineBeast": 1.5,
      "sacred": 1.8,
      "primordial": 2.5
    },
    "wildKukuSpawnRate": 10,
    "captureReward": {
      "coinMin": 5,
      "coinMax": 15,
      "soulMin": 0.5,
      "soulMax": 2.0,
      "gemChance": 0.1
    }
  }
}
```

#### 3.1.2 战斗系统配置
```json
{
  "battleSystem": {
    "baseEnemySpawnInterval": 2.0,
    "maxEnemiesOnField": 10,
    "baseDamageMultiplier": 1.0,
    "criticalHitChance": 0.1,
    "criticalHitMultiplier": 2.0,
    "defensePhaseWaves": 20,
    "waveDifficultyMultiplier": 1.15,
    "bossWaveInterval": 5,
    "eliteEnemyInterval": 3
  }
}
```

#### 3.1.3 进化系统配置
```json
{
  "evolutionSystem": {
    "soulRequirementMultiplier": {
      "celestial": 1.0,
      "immortal": 1.5,
      "divineBeast": 2.0,
      "sacred": 3.0,
      "primordial": 5.0
    },
    "attributeIncreasePerLevel": 0.2,
    "maxEvolutionLevel": 5,
    "skillUnlockLevel": 3,
    "evolutionAnimationDuration": 3.0
  }
}
```

### 3.2 用户设置配置

#### 3.2.1 图像设置
```json
{
  "graphics": {
    "resolution": {
      "width": 1920,
      "height": 1080
    },
    "quality": "high",
    "vsync": 1,
    "antiAliasing": 2,
    "shadowQuality": "high",
    "textureQuality": "high",
    "particleQuality": "medium",
    "postProcessing": true
  }
}
```

#### 3.2.2 音频设置
```json
{
  "audio": {
    "masterVolume": 0.8,
    "musicVolume": 0.7,
    "sfxVolume": 0.8,
    "voiceVolume": 0.75,
    "mute": false,
    "audioMode": "stereo"
  }
}
```

#### 3.2.3 控制设置
```json
{
  "controls": {
    "movement": {
      "forward": "w",
      "backward": "s",
      "left": "a",
      "right": "d"
    },
    "combat": {
      "attack": "mouse0",
      "specialAbility": "space",
      "ultimate": "q"
    },
    "interface": {
      "pause": "escape",
      "inventory": "i",
      "map": "tab",
      "captureMode": "c"
    }
  }
}
```

## 4. 配置管理类

### 4.1 全局配置管理器
```csharp
using System;
using System.IO;
using UnityEngine;

[CreateAssetMenu(fileName = "GlobalConfig", menuName = "KukuWorld/Global Configuration")]
public class GlobalConfig : ScriptableObject
{
    [Header("游戏系统配置")]
    public float capturePhaseDuration = 300f;           // 捕捉阶段持续时间(秒)
    public float baseCaptureSuccessRate = 0.7f;        // 基础捕捉成功率
    public float captureDifficultyMultiplier = 1.0f;   // 捕捉难度倍数
    
    [Header("战斗系统配置")]
    public float baseEnemySpawnInterval = 2.0f;        // 基础敌人生成间隔
    public int maxEnemiesOnField = 10;                 // 最大同时在场敌人数量
    public float baseDamageMultiplier = 1.0f;          // 基础伤害倍数
    public float criticalHitChance = 0.1f;             // 暴击几率
    public float criticalHitMultiplier = 2.0f;         // 暴击伤害倍数
    
    [Header("进化系统配置")]
    public float soulRequirementMultiplier = 1.0f;     // 灵魂需求倍数
    public float attributeIncreasePerLevel = 0.2f;     // 每级属性增加
    public int maxEvolutionLevel = 5;                  // 最大进化等级
    public int skillUnlockLevel = 3;                   // 技能解锁等级
    
    [Header("性能配置")]
    public int maxFrameRate = 60;                      // 最大帧率
    public bool vSyncEnabled = true;                   // 垂直同步
    public int textureQuality = 2;                     // 纹理质量(0-3)
    public int shadowQuality = 2;                      // 阴影质量(0-3)
    
    [Header("UI配置")]
    public float uiScale = 1.0f;                       // UI缩放
    public bool showNotifications = true;              // 显示通知
    public bool showTutorialTips = true;               // 显示教程提示
}
```

### 4.2 用户配置管理器
```csharp
using System;
using System.IO;
using UnityEngine;
using Newtonsoft.Json;

[System.Serializable]
public class UserSettings
{
    [Header("图形设置")]
    public Resolution resolution = new Resolution { width = 1920, height = 1080, refreshRate = 60 };
    public int qualityLevel = 2;                       // 画质等级(0-5)
    public bool vsync = true;                          // 垂直同步
    public int antiAliasing = 2;                       // 抗锯齿
    public bool shadows = true;                        // 阴影
    public bool postProcessing = true;                 // 后处理效果
    
    [Header("音频设置")]
    public float masterVolume = 0.8f;                  // 主音量
    public float musicVolume = 0.7f;                   // 音乐音量
    public float sfxVolume = 0.8f;                     // 音效音量
    public float voiceVolume = 0.75f;                  // 语音音量
    public bool muteAudio = false;                     // 静音
    
    [Header("控制设置")]
    public KeyCode moveForward = KeyCode.W;            // 前进
    public KeyCode moveBackward = KeyCode.S;           // 后退
    public KeyCode moveLeft = KeyCode.A;               // 左移
    public KeyCode moveRight = KeyCode.D;              // 右移
    public KeyCode attack = KeyCode.Mouse0;            // 攻击
    public KeyCode specialAbility = KeyCode.Space;     // 特殊能力
    public KeyCode pauseGame = KeyCode.Escape;         // 暂停游戏
    
    [Header("游戏设置")]
    public bool invertYAxis = false;                   // Y轴反转
    public float mouseSensitivity = 1.0f;              // 鼠标灵敏度
    public bool subtitlesEnabled = true;               // 字幕开启
    public bool bloodEffects = true;                   // 血液效果
    public Language gameLanguage = Language.English;   // 游戏语言
    
    public enum Language
    {
        Chinese,
        English,
        Japanese,
        Korean
    }
    
    /// <summary>
    /// 保存用户设置到文件
    /// </summary>
    public void SaveToFile()
    {
        try
        {
            string json = JsonConvert.SerializeObject(this, Formatting.Indented);
            string filePath = Path.Combine(Application.persistentDataPath, "UserSettings.json");
            File.WriteAllText(filePath, json);
            
            Debug.Log("用户设置已保存: " + filePath);
        }
        catch (Exception e)
        {
            Debug.LogError("保存用户设置失败: " + e.Message);
        }
    }
    
    /// <summary>
    /// 从文件加载用户设置
    /// </summary>
    public static UserSettings LoadFromFile()
    {
        string filePath = Path.Combine(Application.persistentDataPath, "UserSettings.json");
        
        if (File.Exists(filePath))
        {
            try
            {
                string json = File.ReadAllText(filePath);
                UserSettings settings = JsonConvert.DeserializeObject<UserSettings>(json);
                
                Debug.Log("用户设置已加载: " + filePath);
                return settings;
            }
            catch (Exception e)
            {
                Debug.LogError("加载用户设置失败: " + e.Message);
            }
        }
        
        // 如果文件不存在或加载失败，返回默认设置
        Debug.Log("使用默认用户设置");
        return new UserSettings();
    }
    
    /// <summary>
    /// 应用图形设置
    /// </summary>
    public void ApplyGraphicsSettings()
    {
        // 设置分辨率
        Screen.SetResolution(resolution.width, resolution.height, Screen.fullScreen);
        
        // 设置画质
        QualitySettings.SetQualityLevel(qualityLevel);
        
        // 设置垂直同步
        QualitySettings.vSyncCount = vsync ? 1 : 0;
        
        // 设置抗锯齿
        QualitySettings.antiAliasing = antiAliasing;
        
        // 设置阴影
        QualitySettings.shadows = shadows ? ShadowQuality.All : ShadowQuality.Disable;
        
        Debug.Log("图形设置已应用");
    }
    
    /// <summary>
    /// 应用音频设置
    /// </summary>
    public void ApplyAudioSettings()
    {
        // 这里需要与音频管理器交互来应用音量设置
        // AudioManager.Instance?.SetVolumes(masterVolume, musicVolume, sfxVolume, voiceVolume);
        // AudioManager.Instance?.SetMute(muteAudio);
        
        Debug.Log("音频设置已应用");
    }
}
```

### 4.3 配置管理器
```csharp
using UnityEngine;
using System.Collections;

public class ConfigurationManager : MonoBehaviour
{
    public static ConfigurationManager Instance { get; private set; }
    
    [Header("配置资源")]
    public GlobalConfig globalConfig;
    public UserSettings userSettings;
    
    [Header("运行时配置")]
    public bool debugMode = false;
    public bool developerMode = false;
    public float gameTimeScale = 1.0f;
    
    // 配置加载状态
    private bool isConfigsLoaded = false;
    
    void Awake()
    {
        if (Instance == null)
        {
            Instance = this;
            DontDestroyOnLoad(gameObject);
            
            LoadAllConfigs();
        }
        else
        {
            Destroy(gameObject);
        }
    }
    
    /// <summary>
    /// 加载所有配置
    /// </summary>
    private void LoadAllConfigs()
    {
        LoadGlobalConfig();
        LoadUserSettings();
        
        isConfigsLoaded = true;
        
        Debug.Log("所有配置已加载完成");
    }
    
    /// <summary>
    /// 加载全局配置
    /// </summary>
    private void LoadGlobalConfig()
    {
        if (globalConfig == null)
        {
            globalConfig = Resources.Load<GlobalConfig>("Configs/GlobalConfig");
            if (globalConfig == null)
            {
                Debug.LogWarning("未找到全局配置文件，使用默认值");
                globalConfig = ScriptableObject.CreateInstance<GlobalConfig>();
            }
        }
    }
    
    /// <summary>
    /// 加载用户设置
    /// </summary>
    private void LoadUserSettings()
    {
        userSettings = UserSettings.LoadFromFile();
        if (userSettings == null)
        {
            Debug.LogWarning("未找到用户设置文件，使用默认设置");
            userSettings = new UserSettings();
        }
    }
    
    /// <summary>
    /// 保存用户设置
    /// </summary>
    public void SaveUserSettings()
    {
        if (userSettings != null)
        {
            userSettings.SaveToFile();
        }
    }
    
    /// <summary>
    /// 应用所有设置
    /// </summary>
    public void ApplyAllSettings()
    {
        if (userSettings != null)
        {
            userSettings.ApplyGraphicsSettings();
            userSettings.ApplyAudioSettings();
        }
        
        // 应用时间尺度
        Time.timeScale = gameTimeScale;
        
        Debug.Log("所有设置已应用");
    }
    
    /// <summary>
    /// 重置为默认设置
    /// </summary>
    public void ResetToDefaults()
    {
        userSettings = new UserSettings();
        ApplyAllSettings();
        SaveUserSettings();
        
        Debug.Log("已重置为默认设置");
    }
    
    /// <summary>
    /// 检查配置是否已加载
    /// </summary>
    public bool IsConfigsLoaded()
    {
        return isConfigsLoaded;
    }
    
    /// <summary>
    /// 获取全局配置
    /// </summary>
    public GlobalConfig GetGlobalConfig()
    {
        return globalConfig;
    }
    
    /// <summary>
    /// 获取用户设置
    /// </summary>
    public UserSettings GetUserSettings()
    {
        return userSettings;
    }
    
    /// <summary>
    /// 更新运行时配置
    /// </summary>
    public void UpdateRuntimeConfig(float newTimeScale, bool newDebugMode)
    {
        gameTimeScale = newTimeScale;
        debugMode = newDebugMode;
        
        Time.timeScale = gameTimeScale;
        
        Debug.Log($"运行时配置已更新: TimeScale={gameTimeScale}, DebugMode={debugMode}");
    }
    
    /// <summary>
    /// 验证配置完整性
    /// </summary>
    public bool ValidateConfigs()
    {
        bool isValid = true;
        
        // 验证全局配置
        if (globalConfig == null)
        {
            Debug.LogError("全局配置为空");
            isValid = false;
        }
        
        // 验证用户设置
        if (userSettings == null)
        {
            Debug.LogError("用户设置为空");
            isValid = false;
        }
        
        // 验证数值范围
        if (globalConfig != null)
        {
            if (globalConfig.capturePhaseDuration <= 0)
            {
                Debug.LogError("捕捉阶段持续时间必须大于0");
                isValid = false;
            }
            
            if (globalConfig.baseCaptureSuccessRate < 0 || globalConfig.baseCaptureSuccessRate > 1)
            {
                Debug.LogError("基础捕捉成功率必须在0-1之间");
                isValid = false;
            }
        }
        
        return isValid;
    }
}
```

## 5. 配置验证和测试

### 5.1 配置验证工具
```csharp
#if UNITY_EDITOR
using UnityEditor;
using UnityEngine;

public class ConfigValidator : EditorWindow
{
    private Vector2 scrollPosition;
    
    [MenuItem("Tools/KukuWorld/Config Validator")]
    public static void ShowWindow()
    {
        GetWindow<ConfigValidator>("配置验证器");
    }
    
    void OnGUI()
    {
        GUILayout.Label("KukuWorld 配置验证工具", EditorStyles.boldLabel);
        
        scrollPosition = EditorGUILayout.BeginScrollView(scrollPosition);
        
        if (GUILayout.Button("验证全局配置"))
        {
            ValidateGlobalConfig();
        }
        
        if (GUILayout.Button("验证用户设置"))
        {
            ValidateUserSettings();
        }
        
        if (GUILayout.Button("验证所有配置"))
        {
            ValidateAllConfigs();
        }
        
        if (GUILayout.Button("重置为默认值"))
        {
            ResetToDefaults();
        }
        
        EditorGUILayout.EndScrollView();
    }
    
    private void ValidateGlobalConfig()
    {
        GlobalConfig config = ConfigurationManager.Instance?.GetGlobalConfig();
        if (config == null)
        {
            Debug.LogError("无法获取全局配置");
            return;
        }
        
        // 验证各项配置
        bool isValid = true;
        
        if (config.capturePhaseDuration <= 0)
        {
            Debug.LogError("捕捉阶段持续时间无效: " + config.capturePhaseDuration);
            isValid = false;
        }
        
        if (config.baseCaptureSuccessRate < 0 || config.baseCaptureSuccessRate > 1)
        {
            Debug.LogError("基础捕捉成功率无效: " + config.baseCaptureSuccessRate);
            isValid = false;
        }
        
        if (isValid)
        {
            Debug.Log("全局配置验证通过");
        }
        else
        {
            Debug.LogWarning("全局配置存在错误");
        }
    }
    
    private void ValidateUserSettings()
    {
        UserSettings settings = ConfigurationManager.Instance?.GetUserSettings();
        if (settings == null)
        {
            Debug.LogError("无法获取用户设置");
            return;
        }
        
        // 验证音频设置
        if (settings.masterVolume < 0 || settings.masterVolume > 1)
        {
            Debug.LogError("主音量超出范围: " + settings.masterVolume);
        }
        
        if (settings.musicVolume < 0 || settings.musicVolume > 1)
        {
            Debug.LogError("音乐音量超出范围: " + settings.musicVolume);
        }
        
        Debug.Log("用户设置验证完成");
    }
    
    private void ValidateAllConfigs()
    {
        ValidateGlobalConfig();
        ValidateUserSettings();
        
        Debug.Log("所有配置验证完成");
    }
    
    private void ResetToDefaults()
    {
        if (EditorUtility.DisplayDialog("重置配置", "确定要重置所有配置为默认值吗？", "确定", "取消"))
        {
            ConfigurationManager.Instance?.ResetToDefaults();
            Debug.Log("配置已重置为默认值");
        }
    }
}
#endif
```

## 6. 配置更新和迁移

### 6.1 配置版本管理
```csharp
using System;
using UnityEngine;

[Serializable]
public class ConfigVersion
{
    public string version = "1.0.0";
    public DateTime lastModified;
    public string[] requiredUpdates; // 需要执行的更新脚本
    
    public ConfigVersion()
    {
        version = Application.version;
        lastModified = DateTime.Now;
        requiredUpdates = new string[0];
    }
    
    public bool IsCompatible(string currentVersion)
    {
        // 简单的版本比较逻辑
        return version.StartsWith(currentVersion.Split('.')[0]);
    }
}

public class ConfigUpdater : MonoBehaviour
{
    private ConfigVersion currentVersion;
    
    void Start()
    {
        LoadConfigVersion();
        CheckForUpdates();
    }
    
    private void LoadConfigVersion()
    {
        string versionJson = PlayerPrefs.GetString("ConfigVersion", "");
        if (!string.IsNullOrEmpty(versionJson))
        {
            currentVersion = JsonUtility.FromJson<ConfigVersion>(versionJson);
        }
        else
        {
            currentVersion = new ConfigVersion();
            SaveConfigVersion();
        }
    }
    
    private void SaveConfigVersion()
    {
        if (currentVersion != null)
        {
            string versionJson = JsonUtility.ToJson(currentVersion);
            PlayerPrefs.SetString("ConfigVersion", versionJson);
            PlayerPrefs.Save();
        }
    }
    
    private void CheckForUpdates()
    {
        string currentAppVersion = Application.version;
        
        if (currentVersion == null || !currentVersion.IsCompatible(currentAppVersion))
        {
            Debug.Log($"配置需要从 {currentVersion?.version} 更新到 {currentAppVersion}");
            PerformUpdate(currentAppVersion);
        }
    }
    
    private void PerformUpdate(string newVersion)
    {
        // 执行配置更新逻辑
        Debug.Log("执行配置更新到版本: " + newVersion);
        
        // 更新版本信息
        currentVersion.version = newVersion;
        currentVersion.lastModified = DateTime.Now;
        
        SaveConfigVersion();
    }
}
```

## 7. 平台特定配置

### 7.1 平台配置管理
```csharp
using UnityEngine;

public class PlatformConfigManager : MonoBehaviour
{
    [System.Serializable]
    public class PlatformSpecificSettings
    {
        public bool enableDynamicBatching = true;
        public bool enableStaticBatching = true;
        public int lodBias = 1;
        public int maximumLODLevel = 0;
        public float streamingMipmapsRenderersPerFrame = 500;
        public bool streamingMipmapsMaxFileIORequests = true;
    }
    
    [Header("平台特定设置")]
    public PlatformSpecificSettings pcSettings;
    public PlatformSpecificSettings mobileSettings;
    public PlatformSpecificSettings consoleSettings;
    
    void Start()
    {
        ApplyPlatformSettings();
    }
    
    private void ApplyPlatformSettings()
    {
        PlatformSpecificSettings settings = GetPlatformSettings();
        
        if (settings != null)
        {
            // 应用批处理设置
            DynamicGI.enabled = settings.enableDynamicBatching;
            
            // 应用LOD设置
            QualitySettings.lodBias = settings.lodBias;
            QualitySettings.maximumLODLevel = settings.maximumLODLevel;
            
            // 应用纹理流设置
            QualitySettings.streamingMipmapsRenderersPerFrame = settings.streamingMipmapsRenderersPerFrame;
            QualitySettings.streamingMipmapsMaxFileIORequests = settings.streamingMipmapsMaxFileIORequests;
            
            Debug.Log($"已应用 {Application.platform} 平台特定设置");
        }
    }
    
    private PlatformSpecificSettings GetPlatformSettings()
    {
        switch (Application.platform)
        {
            case RuntimePlatform.WindowsPlayer:
            case RuntimePlatform.OSXPlayer:
            case RuntimePlatform.LinuxPlayer:
                return pcSettings;
                
            case RuntimePlatform.Android:
            case RuntimePlatform.IPhonePlayer:
                return mobileSettings;
                
            case RuntimePlatform.PS4:
            case RuntimePlatform.XboxOne:
            case RuntimePlatform.Switch:
                return consoleSettings;
                
            default:
                return pcSettings; // 默认使用PC设置
        }
    }
}
```

## 8. 配置最佳实践

### 8.1 配置管理最佳实践

1. **分层配置**: 使用默认配置、用户配置、运行时配置的分层架构
2. **验证机制**: 实施配置验证以确保数值在合理范围内
3. **版本控制**: 跟踪配置版本并在更新时执行迁移
4. **性能考虑**: 避免频繁的配置文件读写操作
5. **安全性**: 敏感配置信息应加密存储

### 8.2 用户体验考虑

1. **默认值合理**: 提供合理的默认配置值
2. **即时生效**: 大多数设置应即时应用而无需重启
3. **重置选项**: 提供重置为默认设置的功能
4. **导入导出**: 支持配置文件的导入导出功能

这份配置和设置文档为KukuWorld游戏提供了全面的配置管理指导，确保游戏在各种环境下都能正确运行并提供良好的用户体验。